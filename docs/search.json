[
  {
    "objectID": "slides/08_did.html#imputation-based-estimation-example",
    "href": "slides/08_did.html#imputation-based-estimation-example",
    "title": "(8) Difference-in-Differences",
    "section": "Imputation-based Estimation: Example",
    "text": "Imputation-based Estimation: Example\n\nAssess the impact of job displacement (i.e. losing job w/o own fault, e.g. mass layoff) on income of 1,298 individuals.\n\n\n\n\nlibrary(did2s) # Load the 'did' package\nlibrary(tidyverse) # Load the 'tidyverse' package\ntemp_file &lt;- tempfile(fileext = \".RData\") # Define a temporary file path to save the downloaded file\n# Download the file from Dropbox\ndownload.file(\"https://www.dropbox.com/scl/fi/wnp1hrkz00izr72h6ua1t/job_displacement_data.RData?rlkey=nr15rrbv1ev8ra1kzfa1knux2&dl=1\", temp_file, mode = \"wb\")\nload(temp_file) # Load the RData file into the R session\nrm(temp_file) # Optionally, remove the temporary file\n\njob_displacement_data &lt;- job_displacement_data |&gt; \n  # create time-variant treatment indicator D_it\n  mutate(d_it = case_when(\n    group == 0 ~ 0,\n    year &gt;= group ~ 1,\n    TRUE ~ 0)\n  ) |&gt;\n  # create releative event-time indicator D_it_k\n  mutate(d_it_k = case_when(\n    group == 0 ~ Inf,\n    TRUE ~ year - group)\n  )\n\n\n# Static model\nresult &lt;- did2s(\n  job_displacement_data,\n  yname = \"income\",\n  first_stage = ~ occ_score | id + year, # only time-variant covariates\n  second_stage = ~ d_it,\n  treatment = \"d_it\",\n  cluster_var = \"id\"\n)\n\nfixest::esttable(result)\n\n\n# Event Study\nresult &lt;- did2s(\n  job_displacement_data,\n  yname = \"income\",\n  first_stage = ~ occ_score | id + year, # only time-variant covariates\n  second_stage = ~ i(d_it_k, ref = c(-3, Inf)),\n  treatment = \"d_it\",\n  cluster_var = \"id\"\n)\n\n# Dynamic TWFE\ntwfe &lt;- feols(income ~ i(d_it_k, ref = c(-3, Inf)) + occ_score | id + year,\n              data=job_displacement_data,\n              cluster=c(\"id\", \"year\"))\n\nfixest::iplot(list(result, twfe), main = \"Event study: Staggered treatment\", \n              xlab = \"Relative time to treatment\", col = c(\"#005e73\", \"#00C1D4\") , ref.line = -0.5)\n# Legend\nlegend(x=5, y=30000, col = c(\"#005e73\", \"#00C1D4\"), pch = c(20, 17), \n       legend = c(\"Two-stage estimate\", \"Dynamic TWFE\"))\n\n\n\n\nOLS estimation, Dep. Var.: income\nObservations: 11,448\nStandard-errors: Custom \n     Estimate Std. Error  t value  Pr(&gt;|t|)    \nd_it -5900.79    2151.88 -2.74215 0.0061132 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 15,051.3   Adj. R2: 0.006894"
  },
  {
    "objectID": "slides/08_did.html#testing-for-pre-existing-trends",
    "href": "slides/08_did.html#testing-for-pre-existing-trends",
    "title": "(8) Difference-in-Differences",
    "section": "Testing for Pre-existing Trends",
    "text": "Testing for Pre-existing Trends\n\nIn most DiD applications we have several periods before anyone was treated.\nWe can test whether the groups were moving in parallel prior to the treatment.\n\nIf so, then assumption that confounding factors are stable seems more plausible.\nIf not, then it’s relatively implausible that would have magically started moving in parallel after treatment date.\n\nEvent study plot is a common way to visualize pre-trends, which van be generated based on:\n\nDynamic TWFE (not robust with staggered timing).\nComparision-based estimators.\nImputation-based, two-stage estimators."
  },
  {
    "objectID": "slides/08_did.html#issues-with-pre-existing-trends-roth-2022",
    "href": "slides/08_did.html#issues-with-pre-existing-trends-roth-2022",
    "title": "(8) Difference-in-Differences",
    "section": "Issues with Pre-existing Trends (Roth, 2022)",
    "text": "Issues with Pre-existing Trends (Roth, 2022)\n\nParallel pre-trends don’t necessarily imply parallel (counterfactual) post-treatment trends.\n\nIf other policies change at the same time as the one of interest can produce parallel pre-trends but non-parallel post-trends.\n\nLow power: even if pre-trends are non-zero, we may fail to detect it statistically\nDistortions from pre-testing: if we only analyze cases without statistically significant pre-trends, this introduces a form of selection bias (pre-test bias which can make things worse).\nIf we fail the pre-test, what next? May still want to write a paper (especially if violation is “small”)."
  },
  {
    "objectID": "slides/08_did.html#issues-with-pre-existing-trends-roth-2022-1",
    "href": "slides/08_did.html#issues-with-pre-existing-trends-roth-2022-1",
    "title": "(8) Difference-in-Differences",
    "section": "Issues with Pre-existing Trends (Roth, 2022)",
    "text": "Issues with Pre-existing Trends (Roth, 2022)\n\n\n\nPower issues in pre-trend testing: We can’t reject zero pre-trend, but we also can’t reject pre-trends that under smooth extrapolations to the post-treatment period would produce substantial bias.\n\n\n\n\n\n\n\n\nDistortions from pre-testing: If we happen to draw sample from the population where pre-trends are insignificant, the treatment effect we discover later on might be significantly biased (upwards in this example)."
  },
  {
    "objectID": "slides/08_did.html#solutions-to-parallel-trends-testing",
    "href": "slides/08_did.html#solutions-to-parallel-trends-testing",
    "title": "(8) Difference-in-Differences",
    "section": "Solutions to Parallel Trends Testing",
    "text": "Solutions to Parallel Trends Testing\n\nRoth (2022):\n\nDiagnostics of power and distortions from pre-testing.\n\nPower: calculates the slope of a linear violation of parallel trends that a pre-trends test would detect a specified fraction of the time.\nDistortions: calculates the bias that would result from only analyzing cases with statistically significant pre-trends.\n\nR package ‘pretrends’\n\nRambachan and Roth (2022):\n\nFormal sensitivity analysis that avoids pre-testing:\n\nPut bounds to the unobservable post-treatment trend: how different could it be from the pre-treatment trend to invalidate the DiD estimate?\n\nR package ‘HonestDiD’"
  },
  {
    "objectID": "slides/08_did.html#focus-att-after-treatment",
    "href": "slides/08_did.html#focus-att-after-treatment",
    "title": "(8) Difference-in-Differences",
    "section": "Focus: ATT After Treatment",
    "text": "Focus: ATT After Treatment\n\nUnconfoundedness assumption \\(\\{Y(0), Y(1)\\} \\perp\\!\\!\\!\\perp T\\) helps to identify the ATE: \\(\\tau_{\\text{ATE}} = \\mathbb{E}[Y_i|T_i=1] - \\mathbb{E}[Y_i|T_i=0]\\).\nAverage Treatment Effect on the Treated (ATT): \\(\\tau_{\\text{ATT}} = \\mathbb{E}[Y_i(1) - Y_i(0) | T_i=1]\\)\n\nWeaker identification assumption suffices: \\(Y(0) \\perp\\!\\!\\!\\perp T|X\\):\n\n\n\n\\[\n\\begin{align*}\n\\tau_{\\text{ATT}} = \\mathbb{E}[Y_i(1) - Y_i(0) | T_i=1] &= \\mathbb{E}[Y_i(1) | T_i=1] - \\mathbb{E}[Y_i(0) | T_i=1] \\\\\n&= \\mathbb{E}[Y_i | T_i=1] - \\mathbb{E}[Y_i(0) | T_i=1] \\\\\n&= \\mathbb{E}[Y_i | T_i=1] - \\mathbb{E}[Y_i(0) | T_i=0] \\\\\n&= \\mathbb{E}[Y_i | T_i=1] - \\mathbb{E}[Y_i | T_i=0]\n\\end{align*}\n\\]\n\n\n\nIntroducing time periods before and after treatment \\(t=0,1\\):\n\n\\(\\tau_{\\text{DiD}} = \\mathbb{E}[Y_{i,t=1}(1) - Y_{i,t=1}(0) | T_i=1]\\)"
  },
  {
    "objectID": "slides/08_did.html#assumptions-and-definition",
    "href": "slides/08_did.html#assumptions-and-definition",
    "title": "(8) Difference-in-Differences",
    "section": "Assumptions and Definition",
    "text": "Assumptions and Definition\n\nIn addition to SUTVA (consistency & no interference), two new assumptions:\n\n\n\n\nAssumption (A.pt) “Parallel Trends”\n\n\n\\(\\mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | T_i=1] = \\mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | T_i=0]\\).\n\n\n\n\nEquivalent to unconfoundedness of the change (rather than potential outcomes themselves): \\((Y_1(0)-Y_0(0)) \\perp\\!\\!\\!\\perp T\\).\n\n\n\n\n\nAssumption (A.na) “No Anticipation”\n\n\n\\(\\mathbb{E}[Y_{i,t=0}(1) - Y_{i,t=0}(0) | T_i=1] = 0 \\quad\\) or \\(\\quad Y_{i,t=0}(1) = Y_{i,t=0}(0)\\)\n\n\n\n\nTreatment has no effect on the treatment group before it is administered.\n\n\n\n\n\n\nDefinition “Difference-in-Differences ATT”\n\n\n\nGiven consistency, parallel trends, and no anticipation, the ATT is given by the difference between change in the treated group and change in the control group:\n\n\\(\\tau_{\\text{DiD}} = \\mathbb{E}[Y_{i,t=1}(1) - Y_{i,t=1}(0) | T_i=1] = (\\mathbb{E}[Y_{i,t=1} | T_i=1] - \\mathbb{E}[Y_{i,t=0} | T_i=1]) - (\\mathbb{E}[Y_{i,t=1} | T_i=0] - \\mathbb{E}[Y_{i,t=0} | T_i=0])\\)."
  },
  {
    "objectID": "slides/08_did.html#identification",
    "href": "slides/08_did.html#identification",
    "title": "(8) Difference-in-Differences",
    "section": "Identification",
    "text": "Identification\n\nProof:\n\n\\[\n\\begin{aligned}\n\\tau_{\\text{DiD}} = \\mathbb{E}[Y_{i,1}(1) - Y_{i,1}(0) | T_i=1] &\\overset{\\text{LIE}}{=} \\mathbb{E}[Y_{i,1}(1) | T_i=1] - \\mathbb{E}[Y_{i,1}(0) | T_i=1] \\\\\n&= \\mathbb{E}[Y_{i,1}(1) | T_i=1] {\\color{#00C1D4}- \\mathbb{E}[Y_{i,0}(0) | T_i=1]} - \\mathbb{E}[Y_{i,1}(0) | T_i=1] {\\color{#00C1D4}+ \\mathbb{E}[Y_{i,0}(0) | T_i=1]} \\\\\n& \\overset{\\text{(A.na)}}{=} \\mathbb{E}[Y_{i,1}(1) | T_i=1] -\\mathbb{E}[Y_{i,0}({\\color{#00C1D4}1}) | T_i=1] - \\mathbb{E}[Y_{i,1}(0) | T_i=1] + \\mathbb{E}[Y_{i,0}(0) | T_i= 1] \\\\\n& \\overset{\\text{(SUTVA)}}{=} {\\color{#00C1D4}\\mathbb{E}[Y_{i,1} | T_i=1]} - {\\color{#00C1D4}\\mathbb{E}[Y_{i,0} | T_i=1]} - {\\color{#FF7E15}(\\mathbb{E}[Y_{i,1}(0) - Y_{i,0}(0) | T_i= 1])} \\\\\n& \\overset{\\text{(A.pt)}}{=} \\mathbb{E}[Y_{i,1} | T_i=1] - \\mathbb{E}[Y_{i,0} | T_i=1] - {\\color{#00C1D4}(\\mathbb{E}[Y_{i,1}(0) - Y_{i,0}(0) | T_i= 0])} \\\\\n&\\overset{\\text{LIE}}{=} \\mathbb{E}[Y_{i,1} | T_i=1] - \\mathbb{E}[Y_{i,0} | T_i=1] - (\\mathbb{E}[Y_{i,1}(0) | T_i=0] - \\mathbb{E}[Y_{i,0}(0) | T_i=0]) \\\\\n&\\overset{\\text{SUTVA}}{=} \\underbrace{\\mathbb{E}[Y_{i,1} | T_i=1] - \\mathbb{E}[Y_{i,0} | T_i=1]}_{\\text{change in the treated group}} - \\underbrace{(\\mathbb{E}[Y_{i,1} | T_i=0] - \\mathbb{E}[Y_{i,0} | T_i=0])}_{\\text{change in the control group}} \\\\\n\\end{aligned}\n\\]"
  },
  {
    "objectID": "slides/08_did.html#how-did-estimation-works",
    "href": "slides/08_did.html#how-did-estimation-works",
    "title": "(8) Difference-in-Differences",
    "section": "How DiD Estimation Works",
    "text": "How DiD Estimation Works"
  },
  {
    "objectID": "slides/08_did.html#diff-in-diffs-regression",
    "href": "slides/08_did.html#diff-in-diffs-regression",
    "title": "(8) Difference-in-Differences",
    "section": "Diff-in-Diffs Regression",
    "text": "Diff-in-Diffs Regression\n\nDiD estimator \\(\\tau_{\\text{DiD}}\\) can be obtained by two types of regressions:\n\n\nTwo-way fixed effects (TWFE) regression:\n\n\\(Y_{i,t} = \\alpha_i + \\gamma_t + \\tau_{\\text{DiD}} (T_i \\times t) + \\epsilon_{i,t}\\)\nIndividual fixed effects \\(\\alpha_i\\): capture time-invariant characteristics of individuals.\nTime fixed effects \\(\\gamma_t\\): capture time-specific effects common to all individuals.\nInteraction between the treatment \\(T_i\\) and a time dummy \\(t\\): \\(T_i \\times t\\).\nWorks for panel data: i.e. same observations before and after treatment.\n\n\n\n\nRegressing \\(Y_i\\) on the treatment \\(T_i\\), a time dummy \\(t\\) and their interaction \\(T_i \\times t\\): \n\n\\(Y_{i,t} = \\alpha + \\beta T_i + \\gamma t + \\tau_{\\text{DiD}} (T_i \\times t) + \\epsilon_{i,t}\\)\nWorks for both panel data and repeated cross-sectionional data: i.e. different observations before and after treatment."
  },
  {
    "objectID": "slides/08_did.html#diff-in-diffs-regression-1",
    "href": "slides/08_did.html#diff-in-diffs-regression-1",
    "title": "(8) Difference-in-Differences",
    "section": "Diff-in-Diffs Regression",
    "text": "Diff-in-Diffs Regression\n\nGraphical interpretation of \\(Y_{i,t} = \\alpha + \\beta T_i + \\gamma t + \\tau_{\\text{DiD}} (T_i \\times t) + \\epsilon_{i,t}\\):\n\n\\(\\alpha = \\mathbb{E}[Y_{i,0} | T_i=0]\\) is the mean outcome of the nontreated at \\(t=0\\).\n\\(\\beta = \\mathbb{E}[Y_{i,0} | T_i=1] - \\mathbb{E}[Y_{i,0} | T_i=0]\\) is the mean difference in outcomes across treatment groups at \\(t=0\\).\n\nThis selection bias should remain constant in \\(t=1\\).\n\n\\(\\gamma = \\mathbb{E}[Y_{i,1} | T_i=0] - \\mathbb{E}[Y_{i,0} | T_i=0]\\) is the time trend in mean outcomes among the non-treated.\n\nThis trend should be the same (parallel) for the treated group.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \n\nAlternative interpretation: \\[\n\\begin{aligned}\n\\tau_{\\text{DiD}} = \\underbrace{\\mathbb{E}[Y_{i,1} | T_i=1] - \\mathbb{E}[Y_{i,1} | T_i=0]}_{\\text{difference in post-treatment}} \\\\ - \\underbrace{(\\mathbb{E}[Y_{i,0} | T_i=1] - \\mathbb{E}[Y_{i,0} | T_i=0])}_{\\text{difference in pre-treatment}}\n\\end{aligned}\n\\]"
  },
  {
    "objectID": "slides/08_did.html#basic-did-example",
    "href": "slides/08_did.html#basic-did-example",
    "title": "(8) Difference-in-Differences",
    "section": "Basic DiD: Example",
    "text": "Basic DiD: Example\n\nRepeated cross-sectional data: Assess house prices before and after a new highway is built. Repeated cross-section data of 179 houses in 1978 and 142 houses in 1981 in Kiel, Germany. Not the same houses over time.\n\n\nlibrary(wooldridge)  # load wooldridge package for data\nlibrary(fixest) # load fixest package for FE regression\ndata(kielmc)  # load kielmc data\nattach(kielmc)   # attach data\nkielmc$Y = kielmc$rprice  # define outcome\nkielmc$T = kielmc$nearinc # define treatment group\nkielmc$t = kielmc$y81     # define period dummy\n\nfeols(Y ~ T + t + T:t,    # eqivalent to lm(Y ~ T*t)\n      data = kielmc, \n      vcov = vcov_cluster(\"cbd\") # cluster st.error w.r.t. distance to center\n)\n\nOLS estimation, Dep. Var.: Y\nObservations: 321\nStandard-errors: Clustered (cbd) \n            Estimate Std. Error  t value   Pr(&gt;|t|)    \n(Intercept)  82517.2    3221.92 25.61117  &lt; 2.2e-16 ***\nT           -18824.4    7796.29 -2.41453 0.02146099 *  \nt            18790.3    5154.86  3.64516 0.00090981 ***\nT:t         -11863.9    6621.82 -1.79164 0.08236582 .  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 30,053.9   Adj. R2: 0.166131"
  },
  {
    "objectID": "slides/08_did.html#basic-did-example-2",
    "href": "slides/08_did.html#basic-did-example-2",
    "title": "(8) Difference-in-Differences",
    "section": "Basic DiD: Example 2",
    "text": "Basic DiD: Example 2\n\nPanel data: Assess the impact of participating in the U.S. National Supported Work (NSW) training program targeted to individuals with social and economic problems on their real earnings. Experimental vs. non-experimental control group.\n\n\n\n\nlibrary(tidyverse)\nlibrary(fixest)\nlibrary(haven) # to read Stata files\n# 1. Experimental data\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_exp_panel.dta\")\n# ---- Difference-in-means - Averages\nwith(data, {y11 = mean(re[year == 78 & ever_treated == 1])\n              y01 = mean(re[year == 78 & ever_treated == 0])\n              dim = y11 - y01\n              dim})\n\n[1] 1794.342\n\n# 2. Non-Experimental data\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\n# ---- Difference-in-means - Averages\nwith(data, {y11 = mean(re[year == 78 & ever_treated == 1])\n              y01 = mean(re[year == 78 & ever_treated == 0])\n              dim = y11 - y01\n              dim})\n\n[1] -8497.516\n\n# ---- Difference-in-Differences - Averages\nwith(data, {y00 = mean(re[year == 75 & ever_treated == 0])\n              y01 = mean(re[year == 78 & ever_treated == 0])\n              y10 = mean(re[year == 75 & ever_treated == 1])\n              y11 = mean(re[year == 78 & ever_treated == 1])\n              did = (y11 - y10) - (y01 - y00)\n              did})\n\n[1] 3621.232\n\n\n\n\ndata$post_treat = data$ever_treated * (data$year == 78)\n# ---- Difference-in-Differences - Two-Way Fixed Effects Regression\nfeols(re ~ post_treat | id + year, \n        data = data |&gt; filter(year %in% c(75, 78)),\n        vcov = vcov_cluster(c(\"id\", \"year\")))\n# ---- Difference-in-Differences - Interactive Regression\nfeols(re ~ ever_treated + I(year == 78) + post_treat, \n        data = data |&gt; filter(year %in% c(75, 78)),\n        vcov = vcov_cluster(c(\"id\", \"year\")))\n\n\n\nOLS estimation, Dep. Var.: re\nObservations: 32,354\nFixed-effects: id: 16,177,  year: 2\nStandard-errors: Clustered (id & year) \n           Estimate Std. Error t value Pr(&gt;|t|) \npost_treat  3621.23     609.84 5.93801  0.10621 \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 3,859.0     Adj. R2: 0.670904\n                Within R2: 0.002483\n\n\nOLS estimation, Dep. Var.: re\nObservations: 32,354\nStandard-errors: Clustered (id & year) \n               Estimate Std. Error   t value  Pr(&gt;|t|)    \n(Intercept)    13650.80    51.4092  265.5324 0.0023975 ** \never_treated  -12118.75    99.1118 -122.2736 0.0052064 ** \nI(year == 78)   1195.86    21.2944   56.1583 0.0113350 *  \npost_treat      3621.23    41.0534   88.2078 0.0072170 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 9,428.0   Adj. R2: 0.017819"
  },
  {
    "objectID": "slides/08_did.html#parallel-trends-violations",
    "href": "slides/08_did.html#parallel-trends-violations",
    "title": "(8) Difference-in-Differences",
    "section": "Parallel Trends Violations",
    "text": "Parallel Trends Violations\n\nFunctional form misspecification:\n\nSensitive to (even monotonic) transformations of the outcome (e.g. logarithm) unless the treatment is randomly assigned (Roth and Sant’Anna, 2021).\n\n\n\n\nCompositional change with repeated cross-sections:\n\nSample composition may have changed between the pre and post period in ways that are correlated with treatment (Sant’Anna and Xu, 2023).\n\n\n\n\nTime-varying Confounding:\n\nConfounding in diff-in-diffs: covariate with time-varying effect on the outcome or a time-varying difference between groups.\nTime-invariant confounding: covariate differences between groups that are invariant over time, or covariate changes that are invariant across groups - cancel out due to differencing.\nCross-sectional confounding in comparison: covariate associated with treatment & outcome."
  },
  {
    "objectID": "slides/08_did.html#types-of-confounding-covariates",
    "href": "slides/08_did.html#types-of-confounding-covariates",
    "title": "(8) Difference-in-Differences",
    "section": "Types of Confounding Covariates",
    "text": "Types of Confounding Covariates\n\nTime-invariant covariate: \\(X_{i}\\)\n\nDoes not change over time for an individual.\nConfounder if the means of the covariate are different in the two groups and it has a time-varying effect on the outcome.\n\nTime-varying covariate: \\(X_{i,t}\\)\n\nDoes change over time for an individual.\nConfounder if the covariate means evolve differently between the two groups or the covariate means start at different levels and evolve in parallel, and the covariate has a time-varying effect on the outcome."
  },
  {
    "objectID": "slides/08_did.html#handling-of-confounding-covariates",
    "href": "slides/08_did.html#handling-of-confounding-covariates",
    "title": "(8) Difference-in-Differences",
    "section": "Handling of Confounding Covariates",
    "text": "Handling of Confounding Covariates\n\nMost estimation approaches treat all covariates as time-invariant:\n\nTime-varying covariates are fixed at their pre-treatment value across all periods.\nAdvantages: avoids time-varying confounders affected by treatment (mediators are “bad controls”) and helps to reduce the dimensionality of the problem.\nDisadvantage: no control for time trends in X independently of the treatment and thus PT violation remains.\n\nNewer estimation approaches can handle time-varying covariates in more flexible ways (e.g. Caetano and Callaway, 2023):\n\nAll covariates values from each period in each period (highest dimensionality).\nCovariates values from the current period and base period.\nChanges in covariate values from period to period.\nAverage covariate values across time periods."
  },
  {
    "objectID": "slides/08_did.html#conditional-parallel-trends",
    "href": "slides/08_did.html#conditional-parallel-trends",
    "title": "(8) Difference-in-Differences",
    "section": "Conditional Parallel Trends",
    "text": "Conditional Parallel Trends\n\nParallel trend assumption often appear plausible only after controlling for observed covariates \\(\\mathbf{X_i}\\):\n\n\n\n\nAssumption (A.cpt) “Conditional Parallel Trends”\n\n\n\\(\\mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | T_i=1, \\mathbf{X_i}] = \\mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | T_i=0, \\mathbf{X_i}] \\quad\\) and\n\\(\\mathbf{X_i}\\) is not affected by \\(T_i\\): \\(\\quad \\mathbf{X_i}(1) = \\mathbf{X_i}(0) = \\mathbf{X_i}\\)\n\n\n\n\nConditional unconfoundedness of the change (rather than potential outcomes themselves): \\((Y_1(0)-Y_0(0)) \\perp\\!\\!\\!\\perp T \\mid  \\mathbf{X_i}\\).\n\n\n\n\n\nAssumption (A.cna) “Conditionally No Anticipation”\n\n\n\\(\\mathbb{E}[Y_{i,t=0}(1) - Y_{i,t=0}(0) | T_i=1, \\mathbf{X_i}] = 0\\)\n\n\n\n\nTreatment has no effect on the treatment group before it is administered within the same strata of \\(\\mathbf{X_i}\\).\n\n\n\n\n\n\nAssumption (A.pos) “Positivity / Common Support / Overlap”\n\n\n\\(\\Pr(T_i = 1 \\mid \\mathbf{X_i}) &lt; 1 \\space \\text{and} \\space \\Pr(T_i = 1) &gt; 0\\).\n\n\n\n\nFor each treated unit with covariates \\(\\mathbf{X_i}\\), there are at least some untreated units in the population with the same \\(\\mathbf{X_i}\\)."
  },
  {
    "objectID": "slides/08_did.html#att-conditional-on-covariates-identification",
    "href": "slides/08_did.html#att-conditional-on-covariates-identification",
    "title": "(8) Difference-in-Differences",
    "section": "ATT Conditional on Covariates: Identification",
    "text": "ATT Conditional on Covariates: Identification\n\nGiven the conditional parallel trends assumption, no anticipation assumption, and overlap condition, the ATT conditional on \\(\\mathbf{X_i = x}\\), \\(\\tau_{\\text{DiD}}(\\mathbf{x})\\), can be identified for all \\(\\mathbf{x}\\) with \\(\\Pr(T_i = 1 \\mid \\mathbf{X_i = x}) &gt; 0\\) as:\n\n\\[\n\\begin{aligned}\n\\tau_{\\text{DiD}}(\\mathbf{x}) &= \\mathbb{E}[Y_{i,1}(1) - Y_{i,1}(0) | T_i=1, \\mathbf{X_i = x}] \\\\\n&\\overset{\\text{LIE}}{=} \\mathbb{E}[Y_{i,1}(1) | T_i=1, \\mathbf{x}] - \\mathbb{E}[Y_{i,1}(0) | T_i=1, \\mathbf{x}] \\\\\n&= \\mathbb{E}[Y_{i,1}(1) | T_i=1, \\mathbf{x}] {\\color{#00C1D4}- \\mathbb{E}[Y_{i,0}(0) | T_i=1, \\mathbf{x}]} - \\mathbb{E}[Y_{i,1}(0) | T_i=1, \\mathbf{x}] {\\color{#00C1D4}+ \\mathbb{E}[Y_{i,0}(0) | T_i=1, \\mathbf{x}]} \\\\\n& \\overset{\\text{(A.cna)}}{=} \\mathbb{E}[Y_{i,1}(1) | T_i=1, \\mathbf{x}] -\\mathbb{E}[Y_{i,0}({\\color{#00C1D4}1}) | T_i=1, \\mathbf{x}] - \\mathbb{E}[Y_{i,1}(0) | T_i=1, \\mathbf{x}] + \\mathbb{E}[Y_{i,0}(0) | T_i= 1, \\mathbf{x}] \\\\\n& \\overset{\\text{(SUTVA)}}{=} {\\color{#00C1D4}\\mathbb{E}[Y_{i,1} | T_i=1, \\mathbf{x}]} - {\\color{#00C1D4}\\mathbb{E}[Y_{i,0} | T_i=1, \\mathbf{x}]} - {\\color{#FF7E15}(\\mathbb{E}[Y_{i,1}(0) - Y_{i,0}(0) | T_i= 1, \\mathbf{x}])} \\\\\n& \\overset{\\text{(A.cpt)}}{=} \\mathbb{E}[Y_{i,1} | T_i=1, \\mathbf{x}] - \\mathbb{E}[Y_{i,0} | T_i=1, \\mathbf{x}] - {\\color{#00C1D4}(\\mathbb{E}[Y_{i,1}(0) - Y_{i,0}(0) | T_i= 0, \\mathbf{x}])} \\\\\n&\\overset{\\text{LIE}}{=} \\mathbb{E}[Y_{i,1} | T_i=1, \\mathbf{x}] - \\mathbb{E}[Y_{i,0} | T_i=1, \\mathbf{x}] - (\\mathbb{E}[Y_{i,1}(0) | T_i=0, \\mathbf{x}] - \\mathbb{E}[Y_{i,0}(0) | T_i=0, \\mathbf{x}]) \\\\\n&\\overset{\\text{SUTVA}}{=} \\underbrace{\\mathbb{E}[Y_{i,1} | T_i=1, \\mathbf{x}] - \\mathbb{E}[Y_{i,0} | T_i=1, \\mathbf{x}]}_{\\text{change for T=1 and X=x}} - \\underbrace{(\\mathbb{E}[Y_{i,1} | T_i=0, \\mathbf{x}] - \\mathbb{E}[Y_{i,0} | T_i=0, \\mathbf{x}])}_{\\text{change for T=0 and X=x}} \\\\\n\\end{aligned}\n\\]"
  },
  {
    "objectID": "slides/08_did.html#att-conditional-on-covariates-estimation",
    "href": "slides/08_did.html#att-conditional-on-covariates-estimation",
    "title": "(8) Difference-in-Differences",
    "section": "ATT Conditional on Covariates: Estimation",
    "text": "ATT Conditional on Covariates: Estimation\n\nThe unconditional ATT can then be identified by averaging \\(\\tau_{\\text{DiD}}(\\mathbf{x})\\) over the distribution of \\(X_i\\) in the treated population.\nUsing the law of iterated expectations, we have:\n\n\\(\\tau_{\\text{DiD}} = \\mathbb{E}[Y_{i,1}(1) - Y_{i,1}(0) | T_i=1] = \\mathbb{E}_{\\mathbf{X_i}}\\left[ \\underbrace{\\mathbb{E}[Y_{i,1}(1) - Y_{i,1}(0) | T_i=1, \\mathbf{X_i}]}_{\\tau_{\\text{DiD}}(\\mathbf{X_i})} \\mid T_i=1\\right]\\)\n\n\nFour estimation procedures:\n\nTwo-Way Fixed Effects (TWFE) Regression\nOutcome Regression Adjustment\nInverse Probability Weighting (IPW)\nDoubly Robust Estimation"
  },
  {
    "objectID": "slides/08_did.html#two-way-fixed-effects-twfe-regression",
    "href": "slides/08_did.html#two-way-fixed-effects-twfe-regression",
    "title": "(8) Difference-in-Differences",
    "section": "Two-Way Fixed Effects (TWFE) Regression",
    "text": "Two-Way Fixed Effects (TWFE) Regression\n\nAugment TWFE specification with covariates (e.g. Zeldow and Hatfield, 2021):\n\nTime-invariant covariate with time-variant effect on outcome:\n\n\\(Y_{i,t} = \\alpha_i + \\gamma_t + \\tau_{\\text{DiD}} (T_i \\times t) + \\delta (X_i \\times t) + \\epsilon_{i,t}\\)\n\nTime-variant covariate with time-invariant effect on outcome:\n\n\\(Y_{i,t} = \\alpha_i + \\gamma_t + \\tau_{\\text{DiD}} (T_i \\times t) + \\delta X_{it} + \\epsilon_{i,t}\\)\n\nTime-variant covariate with time-variant effect on outcome:\n\n\\(Y_{i,t} = \\alpha_i + \\gamma_t + \\tau_{\\text{DiD}} (T_i \\times t) + \\delta (X_{it} \\times t) + \\epsilon_{i,t}\\)\n\n\n\n\n\nRather strong additional assumptions needed (e.g. Caetano and Callaway, 2023):\n\nTreatment effect is homogeneous across different values of X.\nOutcome is linear in X.\nOnly controlling for covariate changes, not for levels."
  },
  {
    "objectID": "slides/08_did.html#twfe-regression-example",
    "href": "slides/08_did.html#twfe-regression-example",
    "title": "(8) Difference-in-Differences",
    "section": "TWFE Regression: Example",
    "text": "TWFE Regression: Example\n\nlibrary(tidyverse)\nlibrary(fixest)\nlibrary(haven) # to read Stata files\n\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\n\ndata$post_treat = data$ever_treated * (data$year == 78)\ndata$post = as.integer(data$year == 78)\n\n# ---- Difference-in-Differences - Two-Way Fixed Effects Regression\nfeols(\n  re ~ post_treat + age:post + agesq:post + agecube:post + educ:post + educsq:post + marr:post + nodegree:post + black:post + hisp:post | id + year, \n  data = data |&gt; filter(year %in% c(75, 78)),\n  vcov = vcov_cluster(c(\"id\", \"year\"))\n)\n\nOLS estimation, Dep. Var.: re\nObservations: 32,354\nFixed-effects: id: 16,177,  year: 2\nStandard-errors: Clustered (id & year) \n                  Estimate Std. Error   t value Pr(&gt;|t|)    \npost_treat     2450.964333 645.332739  3.797985 0.163900    \nage:post      -1392.968721 188.627206 -7.384771 0.085686 .  \npost:agesq       32.005450   5.576397  5.739450 0.109818    \npost:agecube     -0.254779   0.052340 -4.867790 0.128988    \npost:educ      -132.810162  95.337273 -1.393056 0.396361    \npost:educsq      10.228897   3.957951  2.584392 0.235037    \npost:marr      -578.337803 163.583509 -3.535429 0.175485    \npost:nodegree   417.398327 193.694598  2.154930 0.276597    \npost:black     -281.607046 205.559277 -1.369955 0.401418    \npost:hisp      -126.167682 234.813629 -0.537310 0.686116    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 3,737.9     Adj. R2: 0.691052\n                Within R2: 0.064074"
  },
  {
    "objectID": "slides/08_did.html#outcome-regression-adjustment",
    "href": "slides/08_did.html#outcome-regression-adjustment",
    "title": "(8) Difference-in-Differences",
    "section": "Outcome Regression Adjustment",
    "text": "Outcome Regression Adjustment\n\nRegression Adjustment exploits the fact that under conditional parallel trends, strong overlap, and no anticipation the ATT can be written as (Heckman, Ichimura and Todd, 1997):\n\n\\[\n\\begin{aligned}\n\\tau_{\\text{DiD}} &= \\mathbb{E}_{\\mathbf{X_i}}\\left[\\space \\underbrace{\\mathbb{E}[Y_{i,1} - Y_{i,0} | T_i=1, \\mathbf{X_i}] - \\mathbb{E}[Y_{i,1} - Y_{i,0} | T_i=0, \\mathbf{X_i}]}_{\\tau_{\\text{DiD}}(\\mathbf{X_i})} \\mid T_i=1\\right] \\\\\n&\\overset{\\text{LIE}}{=} \\mathbb{E}[Y_{i,1} - Y_{i,0} | T_i=1] - \\mathbb{E}_{\\mathbf{X_i}}\\left[\\space \\mathbb{E}[Y_{i,1} - Y_{i,0} | T_i=0, \\mathbf{X_i}] \\mid T_i=1\\right]\\\\\n&\\overset{\\text{LIE}}{=} \\mathbb{E}[Y_{i,1} - Y_{i,0} | T_i=1] - \\mathbb{E}_{\\mathbf{X_i}}\\left[\\space \\mathbb{E}[Y_{i,1} | T_i=0, \\mathbf{X_i}] - \\mathbb{E}[Y_{i,0} | T_i=0, \\mathbf{X_i}] \\mid T_i=1\\right]  \\\\\n&:= \\mathbb{E}[Y_{i,1} - Y_{i,0} | T_i=1] - \\mathbb{E}_{\\mathbf{X_i}}\\left[\\space \\mu_{1}(0, \\mathbf{X_i}) - \\mu_{0}(0, \\mathbf{X_i}) \\mid T_i=1\\right]\n\\end{aligned}\n\\]\n\n\nPotential outcome evolution for the treatment group is imputed with a regression based only on X of the control group.\nSample version: \\(\\hat{\\tau}_{\\text{DiD}} =\\frac{1}{N_1} \\underset{i:T_i=1}{\\sum} (( Y_{i,1} - Y_{i,0}) - (\\hat{\\mu}_{1}(0, \\mathbf{X_i}) - \\hat{\\mu}_{0}(0, \\mathbf{X_i})))\\)\n\nEstimate the conditional expectation of the outcome at time \\(t\\), \\(\\hat{\\mu}_{t}(T_i = 0, \\mathbf{X_i})\\) among untreated units.\n\n\nCreate prediction for each treated unit using the covarite values \\(X_i\\) among the treated units.\n\n\nCalculate difference between observed and predicted difference for each treated unit and average."
  },
  {
    "objectID": "slides/08_did.html#outcome-regression-adjustment-example",
    "href": "slides/08_did.html#outcome-regression-adjustment-example",
    "title": "(8) Difference-in-Differences",
    "section": "Outcome Regression Adjustment: Example",
    "text": "Outcome Regression Adjustment: Example\n\nlibrary(tidyverse)\nlibrary(DRDID)\nlibrary(haven) # to read Stata files\n\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\n\n# ---- Difference-in-Differences - Double-robust\nordid(\n  yname = \"re\", tname = \"year\", idname = \"id\", dname = \"ever_treated\", \n  xformla = ~ age + agesq + agecube + educ + educsq + marr + nodegree + black + hisp + re74 + u74,\n  data = data |&gt; filter(year == 75 | year == 78)\n)\n\n Call:\nordid(yname = \"re\", tname = \"year\", idname = \"id\", dname = \"ever_treated\", \n    xformla = ~age + agesq + agecube + educ + educsq + marr + \n        nodegree + black + hisp + re74 + u74, data = filter(data, \n        year == 75 | year == 78))\n------------------------------------------------------------------\n Outcome-Regression DID estimator for the ATT:\n \n   ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] \n1769.9984   643.0996    2.7523     0.0059    509.5233  3030.4736 \n------------------------------------------------------------------\n Estimator based on panel data.\n Outcome regression est. method: OLS.\n Analytical standard error.\n------------------------------------------------------------------\n See Sant'Anna and Zhao (2020) for details."
  },
  {
    "objectID": "slides/08_did.html#outcome-regression-with-ml-example",
    "href": "slides/08_did.html#outcome-regression-with-ml-example",
    "title": "(8) Difference-in-Differences",
    "section": "Outcome Regression with ML: Example",
    "text": "Outcome Regression with ML: Example\n\nlibrary(tidyverse)\nlibrary(mlr3)\nlibrary(mlr3learners)\nlibrary(haven) # to read Stata files\n\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\ndata &lt;- data |&gt; filter(year == 75 | year == 78) |&gt; \n  select(-treat, -data_id) |&gt;\n  pivot_wider(names_from = year, values_from = re, names_prefix = \"re_\") |&gt;\n  mutate(re_diff = re_78 - re_75)\ndata_pred &lt;- data |&gt; select(re_diff, ever_treated, age, agesq, agecube, educ, educsq, \n                              marr, nodegree, black, hisp, re74, u74)\n\n# Define prediction model for the outcome difference delta_mu\ntask_mu &lt;- as_task_regr(data_pred |&gt; select(-ever_treated), target = \"re_diff\")\nlrnr_mu &lt;- lrn(\"regr.ranger\", predict_type = \"response\")\n# learn outcome difference delta_mu among untreated\nlrnr_mu$train(task_mu, row_ids = which(data$ever_treated == 0))\n# predict outcome difference delta_mu among treated\ndelta_mu &lt;- lrnr_mu$predict(task_mu, row_ids = which(data$ever_treated == 1))$response\n\nY1 &lt;- data$re_78[data$ever_treated == 1]\nY0 &lt;- data$re_75[data$ever_treated == 1]\n\nmean( (Y1 - Y0) - delta_mu )\n\n[1] 2188.271"
  },
  {
    "objectID": "slides/08_did.html#inverse-probability-weighting-ipw",
    "href": "slides/08_did.html#inverse-probability-weighting-ipw",
    "title": "(8) Difference-in-Differences",
    "section": "Inverse Probability Weighting (IPW)",
    "text": "Inverse Probability Weighting (IPW)\n\nThe IPW approach proposed by Abadie (2005):\n\n\\(\\tau_{\\text{DiD}} = \\mathbb{E}\\left( \\frac{ Y_{i,1} - Y_{i,0}}{P(T_i=1)} \\frac{T_i - e(\\mathbf{X_i})}{1-e(\\mathbf{X_i})} \\right)\\)\n\\(e(\\mathbf{X_i}) = P[T_i = 1 | \\mathbf{X_i}]\\)\n\nSample version:\n\n\\(\\hat{\\tau}_{\\text{DiD}} = \\frac{1}{N} \\underset{i}{\\sum} \\left( \\frac{ Y_{i,1} - Y_{i,0}}{P(T_i=1)} \\frac{T_i - \\hat{e}(\\mathbf{X_i})}{1-\\hat{e}(\\mathbf{X_i})} \\right)\\)\n\n\n\n\nIntuition: what happens when \\(T_i=1\\) and \\(T_i=0\\)?\n\nWeighting with the propensity only happens to the control group’s first differences – not the treatment groups!\nWhy? Because it’s the \\(Y_1(0)\\) that is missing, not the \\(Y_1(1)\\)."
  },
  {
    "objectID": "slides/08_did.html#iwp-example",
    "href": "slides/08_did.html#iwp-example",
    "title": "(8) Difference-in-Differences",
    "section": "IWP: Example",
    "text": "IWP: Example\n\nlibrary(tidyverse)\nlibrary(DRDID)\nlibrary(haven) # to read Stata files\n\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\n\n# ---- Difference-in-Differences - Double-robust\nipwdid(\n  yname = \"re\", tname = \"year\", idname = \"id\", dname = \"ever_treated\", \n  xformla = ~ age + agesq + agecube + educ + educsq + marr + nodegree + black + hisp + re74 + u74,\n  data = data |&gt; filter(year == 75 | year == 78)\n)\n\n Call:\nipwdid(yname = \"re\", tname = \"year\", idname = \"id\", dname = \"ever_treated\", \n    xformla = ~age + agesq + agecube + educ + educsq + marr + \n        nodegree + black + hisp + re74 + u74, data = filter(data, \n        year == 75 | year == 78))\n------------------------------------------------------------------\n IPW DID estimator for the ATT:\n \n   ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] \n2048.1972   724.1233    2.8285     0.0047    628.9156  3467.4788 \n------------------------------------------------------------------\n Estimator based on panel data.\n Hajek-type IPW estimator (weights sum up to 1).\n Propensity score est. method: maximum likelihood.\n Analytical standard error.\n------------------------------------------------------------------\n See Sant'Anna and Zhao (2020) for details."
  },
  {
    "objectID": "slides/08_did.html#iwp-with-ml-example",
    "href": "slides/08_did.html#iwp-with-ml-example",
    "title": "(8) Difference-in-Differences",
    "section": "IWP with ML: Example",
    "text": "IWP with ML: Example\n\nlibrary(tidyverse)\nlibrary(mlr3)\nlibrary(mlr3learners)\nlibrary(haven) # to read Stata files\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\ndata &lt;- data |&gt; filter(year == 75 | year == 78) |&gt; \n  select(-treat, -data_id) |&gt;\n  pivot_wider(names_from = year, values_from = re, names_prefix = \"re_\")\ndata_pred &lt;- data |&gt; select(re_78, re_75, ever_treated, age, agesq, agecube, educ, educsq, \n                            marr, nodegree, black, hisp, re74, u74)\n\n# Define prediction model for the propensity score e\ntask_e &lt;- as_task_classif(data_pred |&gt; select(-re_78, -re_75), target = \"ever_treated\")\nlrnr_e &lt;- lrn(\"classif.ranger\", predict_type = \"prob\")\n# Learn propensity score e among all observations\nlrnr_e$train(task_e)\n# Predict propensity score ehat\nehat &lt;- lrnr_e$predict(task_e)$prob[, 2]\n\n# Calculate the ATT\nT &lt;- data$ever_treated\nP &lt;- mean(data$ever_treated)\nY1 &lt;- data$re_78\nY0 &lt;- data$re_75\n\nmean( (Y1-Y0)/P * (T - ehat)/(1-ehat) ) \n\n[1] 2906.464"
  },
  {
    "objectID": "slides/08_did.html#doubly-robust-estimation",
    "href": "slides/08_did.html#doubly-robust-estimation",
    "title": "(8) Difference-in-Differences",
    "section": "Doubly Robust Estimation",
    "text": "Doubly Robust Estimation\n\nOutcome regression and IPW approaches can also be combined in the context of Diff-in-Diffs to form “doubly-robust” (DR) methods that are valid if either the outcome model or the propensity score model is correctly specified (Sant’Anna and Zhao, 2020):\n\n\\(\\tau_{\\text{DiD}} = \\mathbb{E}\\left( (Y_{i,1} - Y_{i,0} - (\\mu_{1}(0, \\mathbf{X_i}) - \\mu_{0}(0, \\mathbf{X_i})))  \\left(\\frac{T_i - e(\\mathbf{X_i})}{P(T_i)(1-e(\\mathbf{X_i}))}\\right) \\right)\\)\n\nSample version:\n\n\\(\\hat{\\tau}_{\\text{DiD}} = \\frac{1}{N} \\underset{i}{\\sum} \\left( (Y_{i,1} - Y_{i,0} - (\\hat{\\mu}_{1}(0, \\mathbf{X_i}) - \\hat{\\mu}_{0}(0, \\mathbf{X_i})))  \\left(\\frac{T_i - \\hat{e}(\\mathbf{X_i})}{P(T_i)(1-\\hat{e}(\\mathbf{X_i}))}\\right) \\right)\\)\n\nDouble machine learning for difference-in-differences models (Chang, 2020)."
  },
  {
    "objectID": "slides/08_did.html#doubly-robust-estimation-example",
    "href": "slides/08_did.html#doubly-robust-estimation-example",
    "title": "(8) Difference-in-Differences",
    "section": "Doubly Robust Estimation: Example",
    "text": "Doubly Robust Estimation: Example\n\nlibrary(tidyverse)\nlibrary(DRDID)\nlibrary(haven) # to read Stata files\n\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\n\n# ---- Difference-in-Differences - Double-robust\ndrdid(\n  yname = \"re\", tname = \"year\", idname = \"id\", dname = \"ever_treated\", \n  xformla = ~ age + agesq + agecube + educ + educsq + marr + nodegree + black + hisp + re74 + u74,\n  data = data |&gt; filter(year == 75 | year == 78)\n)\n\n Call:\ndrdid(yname = \"re\", tname = \"year\", idname = \"id\", dname = \"ever_treated\", \n    xformla = ~age + agesq + agecube + educ + educsq + marr + \n        nodegree + black + hisp + re74 + u74, data = filter(data, \n        year == 75 | year == 78))\n------------------------------------------------------------------\n Further improved locally efficient DR DID estimator for the ATT:\n \n   ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] \n2032.9217   707.4779    2.8735     0.0041    646.265   3419.5784 \n------------------------------------------------------------------\n Estimator based on panel data.\n Outcome regression est. method: weighted least squares.\n Propensity score est. method: inverse prob. tilting.\n Analytical standard error.\n------------------------------------------------------------------\n See Sant'Anna and Zhao (2020) for details."
  },
  {
    "objectID": "slides/08_did.html#doubly-robust-estimation-with-ml-example",
    "href": "slides/08_did.html#doubly-robust-estimation-with-ml-example",
    "title": "(8) Difference-in-Differences",
    "section": "Doubly Robust Estimation with ML: Example",
    "text": "Doubly Robust Estimation with ML: Example\n\nlibrary(tidyverse)\nlibrary(mlr3)\nlibrary(mlr3learners)\nlibrary(haven) # to read Stata files\n\ndata &lt;- haven::read_dta(\"https://raw.github.com/Mixtape-Sessions/Causal-Inference-2/master/Lab/Lalonde/lalonde_nonexp_panel.dta\")\ndata &lt;- data |&gt; filter(year == 75 | year == 78) |&gt; \n  select(-treat, -data_id) |&gt;\n  pivot_wider(names_from = year, values_from = re, names_prefix = \"re_\") |&gt;\n  mutate(re_diff = re_78 - re_75)\ndata_pred &lt;- data |&gt; select(re_diff, ever_treated, age, agesq, agecube, educ, educsq, \n                            marr, nodegree, black, hisp, re74, u74)\n\n# Define prediction model for the propensity score e\ntask_e &lt;- as_task_classif(data_pred |&gt; select(-re_diff), target = \"ever_treated\")\nlrnr_e &lt;- lrn(\"classif.ranger\", predict_type = \"prob\")\n# Learn propensity score e among all observations\nlrnr_e$train(task_e)\n# Predict propensity score ehat\nehat &lt;- lrnr_e$predict(task_e)$prob[, 2]\n\n# Define prediction model for the outcome difference delta_mu\ntask_mu &lt;- as_task_regr(data_pred |&gt; select(-ever_treated), target = \"re_diff\")\nlrnr_mu &lt;- lrn(\"regr.ranger\", predict_type = \"response\")\n# learn outcome difference delta_mu among untreated\nlrnr_mu$train(task_mu, row_ids = which(data$ever_treated == 0))\n# predict outcome difference delta_mu among all observations\ndelta_mu &lt;- lrnr_mu$predict(task_mu)$response\n\n# Calculate the ATT\nT &lt;- data$ever_treated\nP &lt;- mean(data$ever_treated)\nY1 &lt;- data$re_78\nY0 &lt;- data$re_75\n\nmean( ((Y1-Y0) - delta_mu) * (T - ehat)/(P*(1-ehat)) )\n\n[1] 2283.593"
  },
  {
    "objectID": "slides/08_did.html#staggered-timing",
    "href": "slides/08_did.html#staggered-timing",
    "title": "(8) Difference-in-Differences",
    "section": "Staggered Timing",
    "text": "Staggered Timing\n\nRemember basic DiD model:\n\nTwo periods and a common treatment date.\nIdentification from parallel trends and no anticipation.\n\nActive recent literature has focused on relaxing the first assumption:\n\nWhat if there are multiple periods and units adopt treatment at different times?\nMaintaining parallel trends and no anticipation assumptions.\n\n\n\n\nNotation:\n\nPanel of observations \\(i\\) and time periods \\(t = 1 ... T_t\\).\nUnits adopt a binary treatment at different dates \\(G_i \\in (1, ..., T_t) \\cup \\infty\\).\n\nwhere \\(G_i = \\infty\\) means never-treated.\n\nPotential outcomes \\(Y_{it}(g)\\) depend on time (\\(t\\)) and time you were first treated (\\(g\\)).\n\n\n\n\n\nLiterature is now starting to consider cases with continuous treatment & treatments that turn on/off.\n\nstill developing; for a review see de Chaisemartin and D’Haultfœuille (2023)."
  },
  {
    "objectID": "slides/08_did.html#extending-the-identifying-assumptions",
    "href": "slides/08_did.html#extending-the-identifying-assumptions",
    "title": "(8) Difference-in-Differences",
    "section": "Extending the Identifying Assumptions",
    "text": "Extending the Identifying Assumptions\n\nKey identifying assumptions from the canonical model are extended in a natural way:\n\n\n\n\nAssumption (A.stpt) “Parallel Trends”\n\n\n\\(\\mathbb{E}[Y_{i,t}(\\infty) - Y_{i,t-1}(\\infty) | G_i=g] = \\mathbb{E}[Y_{i,t-1}(\\infty) - Y_{i,t}(\\infty) | G_i=g'] \\quad \\forall g, g', t\\).\n\n\n\n\nIntuitively, says that if treatment hadn’t happened, all “adoption cohorts” would have parallel average outcomes in all periods. (Note: could impose slightly weaker versions, e.g. only require PT post-treatment).\n\n\n\n\n\nAssumption (A.stna) “No Anticipation”\n\n\n\\(\\mathbb{E}[Y_{i,t}(g) - Y_{i,t}(\\infty) | T_i=1] = 0 \\quad\\) or \\(\\quad Y_{i,t}(g) = Y_{i,t}(\\infty) \\quad \\forall t &lt; g\\)\n\n\n\n\nTreatment has no effect on the treatment group before it is administered."
  },
  {
    "objectID": "slides/08_did.html#twfe-regression-with-staggered-timing",
    "href": "slides/08_did.html#twfe-regression-with-staggered-timing",
    "title": "(8) Difference-in-Differences",
    "section": "TWFE Regression with Staggered Timing",
    "text": "TWFE Regression with Staggered Timing\n\nSuppose we extend Two-way fixed effects (TWFE) regression to staggered treatment timing:\n\n\\(Y_{i,t} = \\alpha_i + \\gamma_t + \\beta D_{it} + \\epsilon_{i,t}\\)\nwhere \\(D_{it} = 1[t \\geq G_i]\\) is an indicator for whether the unit has been treated by time \\(t\\).\n\n\n\n\nGiven no anticipation and parallel trends across all adoption cohorts:\n\nif treatment effect is constant across time and units, \\(Y_{it}(g) - Y_{it}(\\infty) \\equiv \\tau\\), identification possible: \\(\\tau = \\beta\\).\nif treatment effect is heterogeneous, i.e. depends on time since treatement, \\(Y_{it}(t-r) - Y_{it}(\\infty) \\equiv \\tau_r\\), then identification fails, because some \\(\\tau_{r}\\)’s may get negative weights.\n\n\n\n\n\nReason:\n\nClean comparisons: DiD’s between treated and not-yet-treated units.\nForbidden comparisons: DiD’s between already-treated units (who began treatment at different times).\n\ncan lead to negative weights, if treatment effects in the already treated “control group” change over time."
  },
  {
    "objectID": "slides/08_did.html#forbidden-comparisons-in-twfe-intuition",
    "href": "slides/08_did.html#forbidden-comparisons-in-twfe-intuition",
    "title": "(8) Difference-in-Differences",
    "section": "Forbidden Comparisons in TWFE: Intuition",
    "text": "Forbidden Comparisons in TWFE: Intuition\n\n\nSuppose two period model with two groups: always treated (in both periods) & switchers (treated only in period 2).\n\n\nWith two periods, \\(Y_{i,t} = \\alpha_i + \\gamma_t + \\beta D_{it} + \\epsilon_{i,t}\\) is the same as \\(\\Delta Y_{i} = \\alpha +  \\beta \\Delta D_{i} + u_i\\) (by first-differencing).\n\\(\\Delta D_{i} = 1\\) for switchers and \\(0\\) for the control group of always treated, thus:\n\\(\\hat{\\beta} = \\left( \\overline{Y}_{\\text{switchers}, 2} - \\overline{Y}_{\\text{switchers}, 1} \\right) - \\left( \\overline{Y}_{\\text{AT}, 2} - \\overline{Y}_{\\text{AT}, 1} \\right)\\)\nProblem: if treatment effect for always-treated grows over time, \\(\\hat{\\beta}\\) can get negative weights.\n\n\n\n\n\nFrisch-Waugh-Lovell theorem says that we can obtain \\(\\beta\\) in \\(Y_{i,t} = \\alpha_i + \\gamma_t + \\beta D_{it} + \\epsilon_{i,t}\\) in two steps:\n\n\n\nRegress \\(D_{i,t}\\) on fixed effects (in a linear probability model - LPM): \\(D_{i,t} = \\tilde{\\alpha}_i + \\tilde{\\gamma}_t + \\tilde{\\epsilon}_{i,t}\\).\n\n\nRegress \\(Y_{i,t}\\) on \\(D_{i,t} - \\hat{D}_{i,t}\\), thus: \\(\\beta = \\frac{\\mathbb{E}(Y_{i,t}(D_{i,t} - \\hat{D}_{i,t}))}{Var(D_{i,t} - \\hat{D}_{i,t})}\\).\n\nHowever, LPMs can predict \\(\\hat{D}_{i,t} &gt; 1\\), and \\(Y_{it}\\) can get negative weight.\n\n\n\n\n\n\nEven if weights are non-negative (i.e. individual \\(\\tau_i\\)’s are constant - no dynamics), \\(\\beta\\) might still be biased:\n\n\n\\(\\beta = \\sum_{i=1}^{N} \\sum_{t=1}^{T_t} w_{it} \\beta_{it}\\): \\(w_{it}\\) is inversely proportional to the variance of \\(\\beta_{it}\\).\n\nProportional to available information for \\(i\\), i.e. the number of observations pre and post treatment.\n\nBut are individuals in the middle of the panel also the most representative of the population?"
  },
  {
    "objectID": "slides/08_did.html#dynamic-twfe-regression-with-staggered-timing",
    "href": "slides/08_did.html#dynamic-twfe-regression-with-staggered-timing",
    "title": "(8) Difference-in-Differences",
    "section": "Dynamic TWFE Regression with Staggered Timing",
    "text": "Dynamic TWFE Regression with Staggered Timing\n\nSun and Abraham (2021) show that similar issues arise with dynamic TWFE (“event study”) specifications:\n\n\\(Y_{i,t} = \\alpha_i + \\gamma_t + \\sum_{k \\neq 0} \\beta_k D_{it}^k + \\epsilon_{i,t}\\)\nwhere \\(D_{it}^k = 1[t - G_i = k]\\) are leading and lagging “event time” dummies.\n\n\n\n\nThis dynamic specification yields a sensible causal estimand when there is heterogeneity only in time since treatment.\nHowever, if there is heterogeneity in dynamic treatment effects also across adoption cohorts, then:\n\nLike for static TWFE, \\(\\beta_k\\) may put negative weight on treatment effects after k periods for some units.\nFurthermore, \\(\\beta_k\\) may be “contaminated” by treatment effects at different leads and lags \\(k' \\neq k\\).\n\n\n\n\n\nThus, interpreting \\(\\beta_k\\) as estimates …\n\nof the dynamic effects of treatment (\\(k&gt;0\\)) may be misleading.\nfor pre-trends tests (\\(k&lt;0\\)) may also be misleading.\n\nWe will return to pre-trends tests later."
  },
  {
    "objectID": "slides/08_did.html#new-did-estimators-for-staggered-timing",
    "href": "slides/08_did.html#new-did-estimators-for-staggered-timing",
    "title": "(8) Difference-in-Differences",
    "section": "New DiD-Estimators for Staggered Timing",
    "text": "New DiD-Estimators for Staggered Timing\n\nEstimators based on clean aggregated comparisons:\n\nCallaway and Sant’Anna (2021): R package ‘did’ (Focus)\nSun and Abraham (2021): R package ‘fixest’\n\nEstimators based on imputation:\n\nGardner, Thakral, Tô, and Yap (2024): R package ‘did2s’ (Focus)\nBorusyak, Jaravel, Spiess (2024): R package ‘did_imputation’\nWooldridge (2021): R package ‘etwfe’\n\nEstimators that can handle non-absorbing and/or non-binary treatments:\n\nde Chaisemartin and D’Haultfoeuille (2020): R package ‘DIDmultiplegt’\n\nEstimators based on stacking:\n\nCengiz, Dube, Lindner, and Zipperer (2019)\nDube, Girardi, Jorda, and Taylor (2023)"
  },
  {
    "objectID": "slides/08_did.html#estimator-by-callaway-santanna-2021",
    "href": "slides/08_did.html#estimator-by-callaway-santanna-2021",
    "title": "(8) Difference-in-Differences",
    "section": "Estimator by Callaway & Sant’Anna (2021)",
    "text": "Estimator by Callaway & Sant’Anna (2021)\n\nCallaway & Sant’Anna (2021) define the group-time-specific treatment effect on the treated:\n\n\\(\\tau(g, t) = \\mathbb{E}[Y_{i,t}(g) - Y_{i,t}(\\infty) | G_i=g]\\), with \\(t \\geq g\\).\nATT in period \\(t\\) for units first treated in period \\(g\\).\n\n\n\n\nUnder PT and No Anticipation, it can be identified as:\n\n\\(\\tau(g, t) = \\underbrace{\\mathbb{E}[Y_{i,t} - Y_{i,g-1} | G_i=g]}_{\\text{change for cohort g}} - \\underbrace{\\mathbb{E}[Y_{i,t} - Y_{i,g-1} | G_i = \\infty]}_{\\text{change for never-treated}}\\)\nSimilar to the basic model, this is a two-group two-period comparison.\n\nSimilar identification proof (next).\n\nDifferences:\n\n\nPeriod \\(g-1\\) is pre-treatment period (right before cohort g becomes treated).\n\n\nMore flexibility in terms of comparison group: (a) never-treated, (b) not-yet-treated, (c) not-yet-but-eventually-treated, (d) last-to-be-treated.\n\n\n\n\n\n\n\nSample version of \\(\\tau(g, t)\\):\n\n\\(\\hat{\\tau}(g, t) = \\frac{1}{N_{g}} \\sum_{i=1}^{N_g} \\left( Y_{i,t} - Y_{i,g-1} \\right) 1[G_i = g] - \\frac{1}{N_{\\infty}} \\sum_{i=1}^{N_{\\infty}} \\left( Y_{i,t} - Y_{i,g-1} \\right) 1[G_i = \\infty]\\)"
  },
  {
    "objectID": "slides/08_did.html#callaway-santanna-2021-proof",
    "href": "slides/08_did.html#callaway-santanna-2021-proof",
    "title": "(8) Difference-in-Differences",
    "section": "Callaway & Sant’Anna (2021): Proof",
    "text": "Callaway & Sant’Anna (2021): Proof\n\nStart with identification result and work backwards:\n\n\\(\\mathbb{E}[Y_{i,t} - Y_{i,g-1} | G_i=g] - \\mathbb{E}[Y_{i,t} - Y_{i,g-1} | G_i = \\infty]\\)\n\nApply definition of Potential Outcomes:\n\n\\(\\mathbb{E}[Y_{i,t}(g) - Y_{i,g-1}(g) | G_i=g] - \\mathbb{E}[Y_{i,t}(\\infty) - Y_{i,g-1}(\\infty) | G_i = \\infty]\\)\n\nUse No Anticipation to substitute \\(Y_{i,g-1}(\\infty)\\) for \\(Y_{i,g-1}(g)\\):\n\n\\(\\mathbb{E}[Y_{i,t}(g) - Y_{i,g-1}(\\infty) | G_i=g] - \\mathbb{E}[Y_{i,t}(\\infty) - Y_{i,g-1}(\\infty) | G_i = \\infty]\\)\n\nAdd and subtract \\(\\mathbb{E}[Y_{i,t}(\\infty) | G_i=g]\\):\n\n\\(\\mathbb{E}[Y_{i,t}(g) - Y_{i,g-1}(\\infty) | G_i=g] - \\mathbb{E}[Y_{i,t}(\\infty) - Y_{i,g-1}(\\infty) | G_i = \\infty] + \\mathbb{E}[Y_{i,t}(\\infty) | G_i=g] - \\mathbb{E}[Y_{i,t}(\\infty) | G_i=g]\\)\n\nRearrange terms:\n\n\\(\\mathbb{E}[Y_{i,t}(g) - Y_{i,t}(\\infty) | G_i=g] + \\underbrace{\\mathbb{E}[Y_{i,t}(\\infty) - Y_{i,g-1}(\\infty) | G_i=g] - \\mathbb{E}[Y_{i,t}(\\infty) - Y_{i,g-1}(\\infty) | G_i = \\infty]}_{=0}\\)\n\nQED:\n\n\\(\\tau(g, t) = \\mathbb{E}[Y_{i,t}(g) - Y_{i,t}(\\infty) | G_i=g]\\)"
  },
  {
    "objectID": "slides/08_did.html#callaway-santanna-2021-aggregation",
    "href": "slides/08_did.html#callaway-santanna-2021-aggregation",
    "title": "(8) Difference-in-Differences",
    "section": "Callaway & Sant’Anna (2021): Aggregation",
    "text": "Callaway & Sant’Anna (2021): Aggregation\n\nIf have a large number of observations and relatively few groups/periods, can report \\(\\hat{\\tau}(g, t)\\)’s directly.\nIf there are many groups/periods, the \\(\\hat{\\tau}(g, t)\\)’s may be very imprecisely estimated and/or too numerous to report.\nIn these cases, it is often desirable to report meaningful averages of the \\(\\hat{\\tau}(g, t)\\)’s.\nFour aggregation schemes:\n\nSimple:\n\nComputes a single weighted average of all group-time average treatment effects with weights proportional to group size.\n\nDynamic:\n\nComputes event-study parameters which average the \\(\\hat{\\tau}(g, t)\\)’s at a particular lag since (or lengths of exposure to) the treatment.\nCan also be constructed for k &lt; 0 to estimate “pre-trends”.\n\nGroup:\n\nComputes group averages which average the \\(\\hat{\\tau}(g, t)\\)’s for a particular cohort treated a \\(g\\).\n\nCalendar:\n\nComputes “calendar averages” which average the \\(\\hat{\\tau}(g, t)\\)’s for a particular calendar time (year)."
  },
  {
    "objectID": "slides/08_did.html#callaway-santanna-2021-further-variants",
    "href": "slides/08_did.html#callaway-santanna-2021-further-variants",
    "title": "(8) Difference-in-Differences",
    "section": "Callaway & Sant’Anna (2021): Further Variants",
    "text": "Callaway & Sant’Anna (2021): Further Variants\n\nAnticipation:\n\nIn many applications, units may observe that an intervention is about to occur, so that they change their behaviors before the intervention is actually implemented.\nStraightforward adaptation: if there is one period of anticipation, set the base period to \\(g−2\\) rather than \\(g−1\\), so that:\n\n\\(\\tau(g, t) = \\mathbb{E}[Y_{i,t} - Y_{i,g-2} | G_i=g] - \\mathbb{E}[Y_{i,t} - Y_{i,g-2} | G_i = \\infty]\\)\n\n\n\n\n\nCovariates:\n\nStaggered timing estimator can also be extended to include covariates:\n\n\nConditional outcome regression.\n\n\nInverse Probability Weighting.\n\n\nDoubly Robust Estimation."
  },
  {
    "objectID": "slides/08_did.html#callaway-santanna-2021-example",
    "href": "slides/08_did.html#callaway-santanna-2021-example",
    "title": "(8) Difference-in-Differences",
    "section": "Callaway & Sant’Anna (2021): Example",
    "text": "Callaway & Sant’Anna (2021): Example\n\nAssess the impact of job displacement (i.e. losing job w/o own fault, e.g. mass layoff) on income of 1,298 individuals.\n\n\n\n\nlibrary(did) # Load the 'did' package\nlibrary(fixest) # Load the 'fixest' package\ntemp_file &lt;- tempfile(fileext = \".RData\") # Define a temporary file path to save the downloaded file\n# Download the file from Dropbox\ndownload.file(\"https://www.dropbox.com/scl/fi/wnp1hrkz00izr72h6ua1t/job_displacement_data.RData?rlkey=nr15rrbv1ev8ra1kzfa1knux2&dl=1\", temp_file, mode = \"wb\")\nload(temp_file) # Load the RData file into the R session\nrm(temp_file) # Optionally, remove the temporary file\n\n\n# Check the structure of the loaded data\nhead(job_displacement_data)\n\n# run TWFE\nfixest::feols(income ~ i(year &gt;= group) | id + year,\n              data=job_displacement_data,\n              cluster=c(\"id\", \"year\"))\n\n\n\n\n# A tibble: 6 × 7\n       id  year group income female white occ_score\n    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;\n1 7900002  1984     0  31130      1     1         4\n2 7900002  1985     0  32200      1     1         3\n3 7900002  1986     0  35520      1     1         4\n4 7900002  1987     0  43600      1     1         4\n5 7900002  1988     0  39900      1     1         4\n6 7900002  1990     0  38200      1     1         4\n\n\nOLS estimation, Dep. Var.: income\nObservations: 11,682\nFixed-effects: id: 1,298,  year: 9\nStandard-errors: Clustered (id & year) \n                    Estimate Std. Error  t value Pr(&gt;|t|)    \nyear &gt;= group::TRUE -6455.36    2041.49 -3.16208 0.013353 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 14,824.0     Adj. R2: 0.674268\n                 Within R2: 0.002425"
  },
  {
    "objectID": "slides/08_did.html#callaway-santanna-2021-example-contd",
    "href": "slides/08_did.html#callaway-santanna-2021-example-contd",
    "title": "(8) Difference-in-Differences",
    "section": "Callaway & Sant’Anna (2021): Example cont’d",
    "text": "Callaway & Sant’Anna (2021): Example cont’d\n\nAssess the impact of job displacement (i.e. losing job w/o own fault, e.g. mass layoff) on income of 1,298 individuals.\n\n\n\n\n# run command to obtain 64 (8 years * 8 groups) Tau(t,g)'s\nresult &lt;- att_gt(\n  yname = \"income\",\n  tname = \"year\",\n  idname = \"id\",\n  gname = \"group\",\n  xformla = ~ female + white + occ_score, #  ~ 1\n  data = job_displacement_data,\n  allow_unbalanced_panel = TRUE,\n  control_group = \"nevertreated\", # \"notyettreated\"\n  anticipation = 0,\n  clustervars = \"id\",\n  est_method = \"dr\", # \"reg\", \"ipw\"\n  )\n\n# aggregate results over time since treatment\nresult_es &lt;- aggte(result, type=\"dynamic\")\nggdid(result_es)\n\n\n\n\n\n\n\n\n\n\n\n\n# aggregate results over groups and overall\nresult_overall &lt;- aggte(result, type=\"group\")\nsummary(result_overall)\n\n\n\n\nCall:\naggte(MP = result, type = \"group\")\n\nReference: Callaway, Brantly and Pedro H.C. Sant'Anna.  \"Difference-in-Differences with Multiple Time Periods.\" Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; \n\n\nOverall summary of ATT's based on group/cohort aggregation:  \n       ATT    Std. Error     [ 95%  Conf. Int.]  \n -6290.805      1664.296  -9552.766   -3028.844 *\n\n\nGroup Effects:\n Group    Estimate Std. Error [95% Simult.  Conf. Band]  \n  1985  -9152.7025   2998.059    -15874.750   -2430.655 *\n  1986  -1863.3794   5769.769    -14799.971   11073.212  \n  1987    816.6743   6509.247    -13777.925   15411.274  \n  1988   6797.5169   4136.877     -2477.913   16072.947  \n  1990 -13962.6186   3847.891    -22590.104   -5335.134 *\n  1991  -7107.5120   5033.109    -18392.415    4177.391  \n  1992 -10570.4752   8649.169    -29963.066    8822.115  \n  1993 -24680.0159   5672.560    -37398.653  -11961.379 *\n---\nSignif. codes: `*' confidence band does not cover 0\n\nControl Group:  Never Treated,  Anticipation Periods:  0\nEstimation Method:  Doubly Robust"
  },
  {
    "objectID": "slides/08_did.html#imputation-based-estimation-procedure",
    "href": "slides/08_did.html#imputation-based-estimation-procedure",
    "title": "(8) Difference-in-Differences",
    "section": "Imputation-based Estimation: Procedure",
    "text": "Imputation-based Estimation: Procedure\n\nRecall the TWFE specification (with covariates) with the (heterogeneous) \\(\\tau_{it}\\) if PT assumption holds:\n\n\\(Y_{i,t} = \\alpha_i + \\gamma_t + \\tau_{it} D_{it} + \\delta X_{it} + \\epsilon_{i,t}\\)\nwhere \\(D_{it} = T_i \\times t\\) and \\(\\mathbb{E}[\\epsilon_{i,t} | \\{D_{it}, X_{it}\\}_{t=1}^{T_t}] = 0\\)\n\n\n\n\nIf we have some \\(t\\) where \\(D_{it}= 0\\) for all \\(i\\) (e.g. pre-treatment period observations), two-stage procedure:\n\n\nUsing all observations with \\(D_{it}= 0\\), regress \\(Y_{i,t}\\) on the fixed effect \\(\\alpha_i\\) and \\(\\gamma_t\\) as well as on the covariates \\(X_{it}\\):\n\n\n\\(Y_{i,t}(0) = \\alpha_i + \\gamma_t + \\delta X_{it} + \\epsilon_{i,t}\\).\nObtain \\(\\hat{Y}_{i,t}(0) = \\hat{\\alpha}_i + \\hat{\\gamma}_t + \\hat{\\delta} X_{it}\\).\n\n\nRegress adjusted outcomes \\(Y_{i,t} - \\hat{Y}_{i,t}(0)\\) on \\(D_{it}\\) to obtain \\(\\hat{\\tau}_{it}\\):\n\n\n\\((Y_{i,t} - \\hat{Y}_{i,t}(0)) = \\alpha_0 + \\tau_{it} D_{it} + \\epsilon_{i,t}\\).\n\n\n\n\n\n\nWith events studies of the form \\(Y_{i,t} = \\alpha_i + \\gamma_t + \\sum_{k \\neq 0} \\tau_{it}^k D_{it}^k + \\delta X_{it} + \\epsilon_{i,t}\\):\n\n1st stage remains the same.\n2nd stage: Regress adjusted outcomes \\(Y_{i,t} - \\hat{Y}_{i,t}(0)\\) on event dummies \\(D_{it}^k\\) to obtain \\(\\hat{\\tau}_{it}^k\\):\n\n\\((Y_{i,t} - \\hat{Y}_{i,t}(0)) = \\alpha_0 + \\sum_{k \\neq 0} \\tau_{it}^k D_{it}^k + \\epsilon_{i,t}\\)."
  },
  {
    "objectID": "slides/08_did.html#imputation-based-estimation-comparison",
    "href": "slides/08_did.html#imputation-based-estimation-comparison",
    "title": "(8) Difference-in-Differences",
    "section": "Imputation-based Estimation: Comparison",
    "text": "Imputation-based Estimation: Comparison\n\nApproaches of Gardner, Thakral, Tô, and Yap (2024) and Borusyak, Jaravel, Spiess (2024) are very similar:\n\nSame point estimates, but differ in deriving standard errors.\n\n\n\n\nKey difference to C&S (2021) is the trade-off between efficiency and strength of identifying assumption:\n\nPlus: averaging over multiple pre-treatment periods (instead of one) can increase precision.\nMinus: parallel trends need to hold for all groups and time periods (instead of only post-treatment parallel trends)."
  },
  {
    "objectID": "slides/09_synth_c.html#motivation",
    "href": "slides/09_synth_c.html#motivation",
    "title": "(9) Synthetic Controls",
    "section": "Motivation",
    "text": "Motivation\n\n“Synthetic control approach developed by Abadie, Diamond, and Hainmueller (2010, 2014) and Abadie and Gardeazabal (2003) is is arguably the most important innovation in the policy evaluation literature in the last 15 years.” (Athey and Guido W. Imbens, 2017)\nWhat if parallel trends really isn’t realistic?\n\nCreate your own control group that follows approximately the same trajectory as your treatment group pre-treatment.\n\nOriginally designed for comparative case studies:\n\nCompare a single aggregate unit (like a country, state, school, firm, etc.) that is subject so some natural experiment (policy, event) to a synthetic control unit.\nWeighted average of untreated units in order to best resemble the treated unit before the intervention in terms of relevant covariates."
  },
  {
    "objectID": "slides/09_synth_c.html#example",
    "href": "slides/09_synth_c.html#example",
    "title": "(9) Synthetic Controls",
    "section": "Example",
    "text": "Example\n\nAssess the effect of the terrorist conflict in the Basque region on GDP per capita based on a synthetic control created from other Spanish regions.\n\n\n\n\nlibrary(Synth)\nlibrary(SCtools)\ndata(basque)\n\ndataprep.out &lt;- dataprep(\n  foo = basque,\n  predictors = c(\"school.illit\", \"school.prim\", \"school.med\", # define covariates: school degrees and investment as share of GDP\n                 \"school.high\", \"school.post.high\", \"invest\"),\n  time.predictors.prior = 1964:1969, # define pre treatment period to average covariates over\n  special.predictors = list( # addtional predictors with special periods to average over\n    list(\"gdpcap\", 1960:1969 ,\"mean\"), # pre-treatment outcomes - GDP\n    list(\"sec.agriculture\", seq(1961, 1969, 2), \"mean\"), # production in different sectors\n    list(\"sec.energy\", seq(1961, 1969, 2), \"mean\"),\n    list(\"sec.industry\", seq(1961, 1969, 2), \"mean\"),\n    list(\"sec.construction\", seq(1961, 1969, 2), \"mean\"),\n    list(\"sec.services.venta\", seq(1961, 1969, 2), \"mean\"),\n    list(\"sec.services.nonventa\", seq(1961, 1969, 2), \"mean\"),\n    list(\"popdens\",               1969,               \"mean\")), # population density\n  dependent = \"gdpcap\",\n  unit.variable = \"regionno\",\n  unit.names.variable = \"regionname\",\n  time.variable = \"year\",\n  treatment.identifier = 17, #  treated unit\n  controls.identifier = c(2:16, 18), # control units\n  time.optimize.ssr = 1960:1969, # periods to optimize over\n  time.plot = 1955:1997)\n\nsynth.out = synth(dataprep.out)\n\npath.plot(dataprep.res = dataprep.out, synth.res = synth.out,Xlab=\"Year\",Ylab=\"GDP Per Capita\")\nabline(v=1970,lty=2,col=\"#005e73\")\n\n# average treatment effect on the treated over post-treatment period\nmean(dataprep.out$Y1plot[16:43] - (dataprep.out$Y0plot[16:43,] %*% synth.out$solution.w))\n\n\n\n\n\n\n\n\n\n\n\n[1] -0.5799225"
  },
  {
    "objectID": "slides/09_synth_c.html#notation-and-setup",
    "href": "slides/09_synth_c.html#notation-and-setup",
    "title": "(9) Synthetic Controls",
    "section": "Notation and Setup",
    "text": "Notation and Setup\n\n\\(i = 1, \\ldots, N + 1\\) units (countries, regions, firms, etc.).\n\\(t = 1, \\ldots, T_t\\) time periods.\nUnit 1 is treated during periods \\(T_0 + 1, \\ldots, T_t\\).\nRemaining N units are an untreated “donor pool”.\n\\(Y_{it}(0)\\): outcome that would be observed for unit i at time t without treatment\n\\(Y_{it}(1)\\): outcome that would be observed for unit i at time t with treatment in periods \\(T_0 + 1\\) to \\(T_t\\).\nGroup-time specific ATT (with only one treated unit):\n\n\\(\\tau_{1t} = Y_{1t}(1) - Y_{1t}(0) = Y_{1t} - Y_{1t}(0) \\quad \\forall \\quad t &gt; T_0\\)\nEstimate \\(Y_{1t}(0)\\) by weighting the N units in the donor pool."
  },
  {
    "objectID": "slides/09_synth_c.html#weighting-untreated-units",
    "href": "slides/09_synth_c.html#weighting-untreated-units",
    "title": "(9) Synthetic Controls",
    "section": "Weighting Untreated Units",
    "text": "Weighting Untreated Units\n\nWeights: \\(\\mathbf{W} = (w_2, \\ldots, w_{N+1})'\\), with \\(w_i \\geq 0\\) and \\(\\sum_{i=2}^{N+1} w_i = 1\\).\n\nEach \\(\\mathbf{W}\\) defines a potential synthetic control unit.\n\n\\(\\mathbf{X_1}\\) is a \\(k \\times 1\\) vector of pre-intervention covariates for the treated unit.\n\\(\\mathbf{X_0}\\) is a \\(k \\times N\\) matrix of pre-intervention covariates for the donor pool.\n\\(\\mathbf{X_1}\\) and \\(\\mathbf{X_0}\\) can include (the same) covariates over different pre-intervention periods and also pre-intervention outcomes.\nFind \\(\\mathbf{W}* = (w_2^*, \\ldots, w_{N+1}^*)\\) that minimizes \\(\\|  \\mathbf{X}_1 - \\mathbf{X}_0 \\mathbf{W} \\|\\), subject to the weight constraints.\nSynthetic control estimator: \\(\\hat{\\tau}_{1t} = Y_{1t} - \\sum_{i=2}^{N+1} w_i^* Y_{it} \\quad \\forall \\quad t &gt; T_0\\)."
  },
  {
    "objectID": "slides/09_synth_c.html#data-structure",
    "href": "slides/09_synth_c.html#data-structure",
    "title": "(9) Synthetic Controls",
    "section": "Data Structure",
    "text": "Data Structure\n\nUnits \\(i\\) in rows and periods \\(t\\) in columns; assuming:\n\nOnly one pre-treatment covariate \\(X\\) observed for all \\(i\\) and all \\(t\\) (couild also be the pre-treatment outcome).\nOnly one post-treatment period \\(T = T_0 + 1\\).\n\n\n\\[\n\\begin{equation}\n\\left(\n\\begin{array}{c|c}\n\\begin{matrix}\nX_{11} & X_{12} & \\cdots & X_{1T_0} \\\\\n\\hline\nX_{21} & X_{22} & \\cdots & X_{2T_0} \\\\\n\\vdots & \\vdots & \\ddots & \\vdots \\\\\nX_{N1} & X_{N2} & \\cdots & X_{NT_0}\n\\end{matrix}\n&\n\\begin{matrix}\nY_{1T} \\\\\n\\hline\nY_{2T} \\\\\n\\vdots \\\\\nY_{NT}\n\\end{matrix}\n\\end{array}\n\\right)\n\\equiv\n\\left(\n\\begin{array}{c|c}\n\\begin{matrix}\n\\mathbf{X}_{1} \\\\\n\\hline\n\\mathbf{X}_{0}  \\\\\n\\end{matrix}\n&\n\\begin{matrix}\nY_{1T} \\\\\n\\hline\n\\mathbf{Y}_{0T} \\\\\n\\end{matrix}\n\\end{array}\n\\right)\n\\end{equation}\n\\]\n\nGoal of the vertical imputation & estimation approach:\n\nImpute \\(Y_{1T_t}(0)\\) by a weighted-average of \\(\\mathbf{Y}_{0T_t}\\).\nEstimate weights such that \\(\\mathbf{X}_{0}\\) reproduce \\(\\mathbf{X}_{1}\\)."
  },
  {
    "objectID": "slides/09_synth_c.html#optimal-weights",
    "href": "slides/09_synth_c.html#optimal-weights",
    "title": "(9) Synthetic Controls",
    "section": "Optimal Weights",
    "text": "Optimal Weights\n\nOptimal weights \\(\\mathbf{W}^*\\) differ by another weighting matrix \\(\\mathbf{V}\\):\n\n\\(k \\times k\\) symmetric and positive semi-definite matrix, typically assumed to be diagonal:\n\nConstrained, nested optimization problem:\n\n\\[\n\\begin{aligned}\n\\mathbf{W}^* = \\arg\\min_{\\mathbf{W}} \\| \\sqrt{V}\\mathbf{X}_1 - \\mathbf{X}_0 \\mathbf{W} \\|_2^2 &= \\arg\\min_{\\mathbf{W}} [(\\mathbf{X}_1 - \\mathbf{X}_0 \\mathbf{W})' \\mathbf{V} (\\mathbf{X}_1 - \\mathbf{X}_0 \\mathbf{W})] \\\\\n&= \\arg\\min_{\\mathbf{W}} \\sum_{m=1}^{k} v_m \\bigg( X_{1m} - \\sum_{i=2}^{N+1} w_iX_{im}\\bigg)^2 \\\\\n\\end{aligned}\n\\]\n\nSubject to: \\(w_i \\geq 0\\) and \\(\\sum_{i=2}^{N+1} w_i = 1\\).\n\n\n\n\\(v_m\\) is the weight assigned to the \\(m\\)-th covariate should reflect:\n\nits relative importance for the discrepancy between treated and control units.\nits predictive power on the counterfactual outcome of the treated unit 1: \\(Y_{1t}(0)\\)."
  },
  {
    "objectID": "slides/09_synth_c.html#estimating-the-v-matrix",
    "href": "slides/09_synth_c.html#estimating-the-v-matrix",
    "title": "(9) Synthetic Controls",
    "section": "Estimating the V Matrix",
    "text": "Estimating the V Matrix\n\nThe synthetic control shaped by \\(W^*(V^*)\\) to reproduce the behavior of the outcome variable for the treated unit in the absence of the treatment.\nChoice of \\(V^*\\) matrix is critical as it directly shapes the \\(W^*\\) matrix.\nCross-validation to minimize out-of-sample prediction error:\n\nDivide the pre-treatment period into a training and a validation period.\nFor any initialized V, calculate \\(W(V)\\) in the training period.\nApply the \\(W(V)\\) to calculate the Mean Squared Predcition Error (MSPE) in the validation period:\n\\(MSPE = \\frac{1}{T_0} \\sum_{t=1}^{T_0} (Y_{1t} - \\sum_{i=2}^{N+1} w_i^*(V*) Y_{it})^2\\).\nSelect the \\(W^*(V^*)\\) that minimizes the MSPE in the validation period."
  },
  {
    "objectID": "slides/09_synth_c.html#inference",
    "href": "slides/09_synth_c.html#inference",
    "title": "(9) Synthetic Controls",
    "section": "Inference",
    "text": "Inference\n\nInference is based on permutation:\n\nPermutation distribution obtained by iteratively reassigning the treatment to the units in the donor pool and estimating placebo effects in each iteration.\n\nThe effect of the treatment on the unit affected by the intervention is deemed to be significant when its magnitude is extreme relative to the permutation distribution.\np-Value: proportion of placebo effects with a larger Post-MSPE/Pre-MSPE-ratio than the actual treatment effect.\nPermutation distribution is often more informative than mechanically looking at p-values alone.\nDepending on the number of units in the donor pool, conventional significance levels may be unrealistic or impossible.\nOften, one sided inference is most relevant."
  },
  {
    "objectID": "slides/09_synth_c.html#example-inference",
    "href": "slides/09_synth_c.html#example-inference",
    "title": "(9) Synthetic Controls",
    "section": "Example: Inference",
    "text": "Example: Inference\n\n\n\nlibrary(Synth)\nlibrary(SCtools)\n\n# generate placebo tests\nplacebo &lt;- generate.placebos(dataprep.out = dataprep.out,synth.out = synth.out, strategy = \"multisession\")\n\n# p-value: how extreme the treated unit’s ratio is in comparison with that of placebos.\n# but filter out control units with extreme MSPE ratios \n# resulting from poor fit in the pre-treatment period\nmspe_test(placebo, discard.extreme = TRUE, mspe.limit = 5)  \n\n# plot placebo tests, but filter out control units with extreme MSPE ratios \n# resulting from poor fit in the pre-treatment period\nplot_placebos(placebo, discard.extreme = TRUE, mspe.limit = 5)\n\n\n\n$p.val\n[1] 0.8571429\n\n$test\n   MSPE.ratios                         unit\n1    399.28801                    Andalucia\n2     76.85500                       Aragon\n3   7767.20471       Principado De Asturias\n4     55.67757                     Canarias\n5   2564.77781                    Cantabria\n6    470.57144              Castilla Y Leon\n7     22.92823           Castilla-La Mancha\n8     32.11487                     Cataluna\n9    114.23552         Comunidad Valenciana\n10    90.72002                      Galicia\n11   130.86336           Murcia (Region de)\n12   167.21979 Navarra (Comunidad Foral De)\n13   156.15636                   Rioja (La)\n14    55.64514  Basque Country (Pais Vasco)"
  },
  {
    "objectID": "slides/09_synth_c.html#motivation-of-augmented-synthetic-controls",
    "href": "slides/09_synth_c.html#motivation-of-augmented-synthetic-controls",
    "title": "(9) Synthetic Controls",
    "section": "Motivation of Augmented Synthetic Controls",
    "text": "Motivation of Augmented Synthetic Controls\n\nSynthetic control (SC) forces weight to be non-negative, which implies a convex hull constraint:\n\nCounterfactual formed by a weighted combination of control units without extrapolating outside of their convex hull (similar to common support concept).\nHigher validity of the estimated effect based on a more feasible control unit.\nBut also higher chance of a bad pre-treatment fit, so that you should not use the method (Abadie, et al., 2015).\n\nOnly few pre-treatment periods.\n\\(\\mathbf{X_1}\\) is outside the convex hull of \\(\\mathbf{X_0}\\).\n\n\n\n\n\nOLS Regressions to obtain weights \\(\\mathbf{W}\\):\n\nHorizontal, i.e. \\(\\mathbf{Y}_{0T}\\) on \\(\\mathbf{X}_{0}\\), or vertical, i.e. \\(\\mathbf{X}_{1}\\) on \\(\\mathbf{X}_{0}\\).\nBetter (often perfect) pre-treatment fit.\nBut weights are not sparse.\nBut negative weights for some control units, extrapolating outside the support of data."
  },
  {
    "objectID": "slides/09_synth_c.html#augmented-synthetic-controls-approach",
    "href": "slides/09_synth_c.html#augmented-synthetic-controls-approach",
    "title": "(9) Synthetic Controls",
    "section": "Augmented Synthetic Controls: Approach",
    "text": "Augmented Synthetic Controls: Approach\n\nAugmented Synthetic Controls (Ben-Michael, Feller & Rothstein, 2021) as a middle ground:\n\nAssess pre-treatment imbalance via an outcome model and reweigh the original SC model with the new weights.\nAugmentation is doubly robust:\n\nEither the SC model or the outcome model needs to be correct.\n\nAllow for negative weights as little as necessary and sparse weights through regularization.\nDifferent outcome models available in the R package ‘augsynth’:\n\nRidge regression, Elastic Net, Random Forest, Factor Model (gSynth), Matrix Completion (MCPanel), Bayesian structural time series estimation (CausalImpact), Sequence to sequence learning (seq2seq)"
  },
  {
    "objectID": "slides/09_synth_c.html#augmented-synthetic-controls-estimator",
    "href": "slides/09_synth_c.html#augmented-synthetic-controls-estimator",
    "title": "(9) Synthetic Controls",
    "section": "Augmented Synthetic Controls: Estimator",
    "text": "Augmented Synthetic Controls: Estimator\n\nAugmented SC estimator to impute the counterfactual outcome \\(\\hat{Y}_{1T}(0)\\) is given by:\n\n\\[\n\\begin{align*}\n\\hat{Y}_{1T}^{\\text{aug}}(0) &= \\overbrace{\\sum_{i=2}^{N+1} \\hat{w}_i^{\\text{sc}} Y_{iT}}^{\\text{SC estimate}} + \\overbrace{\\left( \\hat{m}_{1T} - \\sum_{i=2}^{N+1} \\hat{w}_i^{\\text{sc}} \\hat{m}_{iT} \\right)}^{\\text{imbalance correction}} \\\\\n&= \\underbrace{\\hat{m}_{1T}}_{\\text{outcome model}} + \\underbrace{\\sum_{i=2}^{N+1} \\hat{w}_i^{\\text{sc}} (Y_{iT} - \\hat{m}_{iT})}_{\\text{\"IPW-like\" re-weights to balance residuals}}\n\\end{align*}\n\\]\n\n\\(\\hat{m}_{iT} = \\hat{m}(\\mathbf{X_i})\\): predicted post-treatment outcome (nuisance parameter) for the (un-) treated units as function of pre-treatment covariates (and / or outcomes)."
  },
  {
    "objectID": "slides/09_synth_c.html#ridge-regression-as-outcome-model",
    "href": "slides/09_synth_c.html#ridge-regression-as-outcome-model",
    "title": "(9) Synthetic Controls",
    "section": "Ridge Regression as Outcome Model",
    "text": "Ridge Regression as Outcome Model\n\nEstimator for the post-treatment outcome is linear in pre-treatment covariates / outcomes:\n\n\\(\\hat{m}(\\mathbf{X_i}) = \\hat{\\eta}_0 + \\mathbf{X_i}' \\mathbf{\\hat{\\eta}}_x\\).\n\\(\\hat{\\eta}_0\\) and \\(\\mathbf{\\hat{\\eta}}_x\\) are the coefficients of a ridge regression of control post-treatment outcomes \\(\\mathbf{Y}_{0T}\\) on centered pre-treatment outcomes \\(\\mathbf{X}_{0}\\) with shrinkage penalty hyperparameter \\(\\lambda\\):\n\n\\(\\{\\hat{\\eta}_0, \\mathbf{\\hat{\\eta}}_x\\} = \\arg\\min_{\\eta_0, \\mathbf{\\eta}_x} \\frac{1}{2} \\sum_{i=2}^{N+1} \\left( Y_i - (\\eta_0 + \\mathbf{X}_i' \\mathbf{\\eta}_x) \\right)^2 + \\lambda \\|\\mathbf{\\eta}_x\\|_2^2\\)\n\n\n\n\n\nRidge Augmented SCM estimator is then given by:\n\n\\(\\hat{Y}_{1T}^{\\text{aug}}(0) = \\sum_{i=2}^{N+1} \\hat{w}_i^{\\text{sc}} Y_{iT} + \\left( \\mathbf{X_1} - \\sum_{i=2}^{N+1} \\hat{w}_i^{\\text{sc}} \\mathbf{X_i} \\right) \\cdot \\mathbf{\\hat{\\eta}}_x\\)\n\n\n\n\n\n\\(\\lambda\\) should be chosen via cross-validation among pre-treatment periods."
  },
  {
    "objectID": "slides/09_synth_c.html#extrapolation-and-regularization",
    "href": "slides/09_synth_c.html#extrapolation-and-regularization",
    "title": "(9) Synthetic Controls",
    "section": "Extrapolation and Regularization",
    "text": "Extrapolation and Regularization\n\n\nSource: Ben-Michael, Feller & Rothstein (2021)."
  },
  {
    "objectID": "slides/09_synth_c.html#conformal-inference",
    "href": "slides/09_synth_c.html#conformal-inference",
    "title": "(9) Synthetic Controls",
    "section": "Conformal Inference",
    "text": "Conformal Inference\n\nFour steps according to Chernozhukov, Wüthrich, Zhu (2021):\n\nFor a given sharp null hypothesis, \\(H0 : \\tau_{1T} = \\tau_0\\), create an adjusted post-treatment outcome for the treated unit \\(\\tilde{Y}_{1T} = Y_{1T} − \\tau_0\\) and extend the original data set to include the adjusted outcome \\(\\tilde{Y}_{1T}\\).\n\n\nApply the augmented SC estimator to obtain adjusted weights \\(\\mathbf{\\hat{W}}(\\tau_0)\\).\n\n\nCompute a p-value by assessing whether the adjusted residual \\(Y_{1T} - \\tau_0 - \\sum_{i=2}^{N+1} \\hat{w}_i(\\tau_0) Y_{iT}\\) “conforms” with the pre-treatment residuals:\n\n\n\\[p(\\tau_0) = \\frac{1}{T} \\sum_{t=1}^{T_0} 1 \\left\\{ \\left| Y_{1T} - \\tau_0 - \\sum_{i=2}^{N+1} \\hat{w}_i(\\tau_0) Y_{iT} \\right| \\leq \\left| Y_{1t} - \\sum_{i=2}^{N+1} \\hat{w}_i(\\tau_0) Y_{it} \\right| \\right\\} + \\frac{1}{T}\\]\n\n\nInverting this test to construct a confidence interval for \\(\\tau\\) is equivalent to constructing a conformal prediction set for \\(Y_{1T}(0)\\) by using the quantiles of pre-treatment residuals:\n\n\n\\[\\hat{C}_Y^{\\text{conf}} = \\left\\{ y \\in \\mathbb{R} \\left| \\left| y - \\sum_{i=2}^{N+1} \\hat{w}_i (Y_{1T} - y) Y_{iT} \\right| \\leq q_{T, \\alpha}^+ \\left( \\left| Y_{1t} - \\sum_{i=2}^{N+1} \\hat{w}_i (Y_{1t} - y) Y_{it} \\right| \\right) \\right. \\right\\}\\]"
  },
  {
    "objectID": "slides/09_synth_c.html#augmented-synthetic-controls-example",
    "href": "slides/09_synth_c.html#augmented-synthetic-controls-example",
    "title": "(9) Synthetic Controls",
    "section": "Augmented Synthetic Controls: Example",
    "text": "Augmented Synthetic Controls: Example\n\nAssess the impact of personal income tax cuts in Kansas on gross state product (GSP) per capita.\n\n\n\n\nlibrary(augsynth)\ndata(kansas)\nattach(kansas)\n                    # outcome ~ treatment | auxillary covariates\nresults &lt;- augsynth(lngdpcapita ~ treated | lngdpcapita + log(revstatecapita) +\n                  log(revlocalcapita) + log(avgwklywagecapita) +\n                  estabscapita + emplvlcapita, \n                unit = fips, \n                time = year_qtr, \n                data = kansas,\n                progfunc = \"Ridge\",#  function to use to impute control outcomes\n                scm = T) # whether to use the SCM\nsummary(results) # summarize the results\nplot(results) # plot the results\n\n# percentage change from the logged treatment effect\n(exp(-0.0609)-1)*100 = -5.9%\n\n\n\n\n\n\n\n\n\n\nCall:\nsingle_augsynth(form = form, unit = !!enquo(unit), time = !!enquo(time), \n    t_int = t_int, data = data, progfunc = \"Ridge\", scm = ..2)\n\nAverage ATT Estimate (p Value for Joint Null):  -0.0609   ( 0.14 )\nL2 Imbalance: 0.054\nPercent improvement from uniform weights: 86.6%\n\nCovariate L2 Imbalance: 0.005\nPercent improvement from uniform weights: 97.7%\n\nAvg Estimated Bias: 0.027\n\nInference type: Conformal inference\n\n    Time Estimate 95% CI Lower Bound 95% CI Upper Bound p Value\n 2012.25   -0.021             -0.044              0.002   0.058\n 2012.50   -0.047             -0.081             -0.019   0.039\n 2012.75   -0.050             -0.083             -0.012   0.031\n 2013.00   -0.045             -0.074             -0.022   0.034\n 2013.25   -0.055             -0.083             -0.022   0.025\n 2013.50   -0.071             -0.110             -0.033   0.025\n 2013.75   -0.058             -0.091             -0.025   0.024\n 2014.00   -0.081             -0.119             -0.037   0.027\n 2014.25   -0.078             -0.116             -0.024   0.013\n 2014.50   -0.065             -0.114             -0.006   0.040\n 2014.75   -0.057             -0.110              0.000   0.050\n 2015.00   -0.075             -0.124             -0.022   0.037\n 2015.25   -0.063             -0.106             -0.014   0.022\n 2015.50   -0.067             -0.106             -0.019   0.025\n 2015.75   -0.063             -0.101             -0.009   0.028\n 2016.00   -0.078             -0.127             -0.030   0.019"
  },
  {
    "objectID": "slides/09_synth_c.html#motivation-1",
    "href": "slides/09_synth_c.html#motivation-1",
    "title": "(9) Synthetic Controls",
    "section": "Motivation",
    "text": "Motivation\n\nAllow multiple units and differential treatment timing, even of parallel trends assumption is violated.\n\nWhen staggered Difference-in-Differences (DiD) does not work then.\n\nGoal: find a coherent way to manage multiple synthetic controls and aggregating them into a single parameter estimate.\nChallenge: balance the imperfect biases in the pooled and the separate unit-level estimates.\nSolution: Partially-pooled synthetic control (Ben-Michael, Feller & Rothstein, 2021b)."
  },
  {
    "objectID": "slides/09_synth_c.html#different-approaches",
    "href": "slides/09_synth_c.html#different-approaches",
    "title": "(9) Synthetic Controls",
    "section": "Different Approaches",
    "text": "Different Approaches\n\nSeparate Synthetic Control: Estimate separate SC models for each treated unit.\n\nOnly works if there is good fit good for each unit.\nPoor average fit leading to biased average treatment effect as target parameter.\n\nPooled Synthetic Control: Minimize the average pre-treatment imbalance across all treated units.\n\nCan achieve nearly perfect fit for the average treated unit.\nCan yield substantially worse unit-specific fits.\n\nPartially-pooled Synthetic Control (Ben-Michael, Feller & Rothstein, 2021b): Minimize a weighted average of the two imbalances.\n\nModify the optimization problem to target overall and unit-specific fit.\nAccount for the level differences with an intercept shift."
  },
  {
    "objectID": "slides/09_synth_c.html#setup-and-notation",
    "href": "slides/09_synth_c.html#setup-and-notation",
    "title": "(9) Synthetic Controls",
    "section": "Setup and Notation",
    "text": "Setup and Notation\n\nOutcome \\(Y_{it}\\) obersved for \\(i = 1 ... N\\) individuals and \\(t = 1 ... T_t\\) time periods.\n\\(T_i\\) is the time period that unit \\(i\\) is treated.\n\nwhere \\(T_i = \\infty\\) denoting never-treated units.\ncan order units by treatment timing: \\(T_1 \\leq T_2 \\leq ... \\leq T_N\\).\n\n\\(N_0 = \\sum_{i=1}^N 1\\{T_i = \\infty\\}\\) is the number of never-treated units.\n\\(J = N - N_0= \\sum_{i=1}^N 1\\{T_i \\neq \\infty\\}\\) is the number of (eventually) treated units.\n\nDifferentiate them with index \\(j = 1 ... J\\).\n\nPotential outcomes \\(Y_{it}(g)\\) depend on time (\\(t\\)) and time you were first treated (\\(g\\)).\nIndividual treatment effect at time \\(t\\) if treated at \\(g\\): \\(\\tau_{i,t}(g) = Y_{i, t}(g) - Y_{i, t}(\\infty)\\).\nNo anticipation: \\(Y_{it}(T_i) = Y_{it}(\\infty)\\) for \\(t &lt; T_i\\)."
  },
  {
    "objectID": "slides/09_synth_c.html#estimands",
    "href": "slides/09_synth_c.html#estimands",
    "title": "(9) Synthetic Controls",
    "section": "Estimands",
    "text": "Estimands\n\nTreatment effect after event time \\(k\\):\n\n\\(\\tau_{j, k} = Y_{j, T_j + k}(T_j) - Y_{j, T_j + k}(\\infty)\\).\n\\(\\tau_{j, k} = 0\\) for any \\(k &lt; 0\\) (no anticipation).\n\nAverage Treatment Effect on the Treated (ATT) \\(k\\) periods after treatment:\n\n\\(\\tau_k = \\frac{1}{J} \\sum_{j=1}^J \\tau_{j, k} = \\frac{1}{J} \\sum_{j=1}^J Y_{j, T_j + k}(T_j) - Y_{j, T_j + k}(\\infty)\\).\n\nAverage post-treatment effect:\n\n\\(\\tau = \\frac{1}{K+1} \\sum_{k=0}^K \\tau_k\\)."
  },
  {
    "objectID": "slides/09_synth_c.html#estimator",
    "href": "slides/09_synth_c.html#estimator",
    "title": "(9) Synthetic Controls",
    "section": "Estimator",
    "text": "Estimator\n\n\\(w_{ij}\\) is the weight on unit \\(i\\) in the synthetic control for unit \\(j\\).\n\n\\(N\\)-by-\\(J\\) matrix of weights: \\(W = [w_{ij}]\\).\n\nAverage Treatment Effect on the Treated (ATT) \\(k\\) periods after treatment: \\[\n\\begin{aligned}\n\\hat{\\tau}_k = \\frac{1}{J} \\sum_{j=1}^J \\hat{\\tau}_{jk} &= \\frac{1}{J} \\sum_{j=1}^J \\left[ Y_{jT_j + k} - \\sum_{i=1}^N \\hat{w}_{ij} Y_{iT_j + k} \\right] \\\\\n&= \\frac{1}{J} \\sum_{j=1}^J Y_{jT_j + k} - \\sum_{i=1}^N \\frac{1}{J} \\sum_{j=1}^J \\hat{w}_{ij} Y_{iT_j + k}\n\\end{aligned}\n\\]\nEquation highlights two equivalent interpretations of the estimator:\n\naverage of unit-specific SCM estimates.\nSCM estimate for the average treated unit."
  },
  {
    "objectID": "slides/09_synth_c.html#optimization-problem",
    "href": "slides/09_synth_c.html#optimization-problem",
    "title": "(9) Synthetic Controls",
    "section": "Optimization Problem",
    "text": "Optimization Problem\n\nOptimize either the sum of the unit-specific imbalances:\n\n\\(q_X^{\\text{sep}}(\\mathbf{W}) = \\sqrt{\\frac{1}{J} \\sum_{j=1}^J \\left\\| \\mathbf{X}_j - \\sum_{i=1}^N w_{ij} \\mathbf{X}_i \\right\\|_2^2}\\)\n\nOr optimize the imbalance of the pooled imbalance:\n\n\\(q_X^{\\text{pool}}(\\mathbf{W}) = \\left\\| \\frac{1}{J} \\sum_{j=1}^J \\mathbf{X}_j - \\sum_{i=1}^N w_{ij} \\mathbf{X}_i \\right\\|_2\\)\n\nInstead, optimize the weighted average of the two (normalized) imbalances \\(\\tilde{q}\\):\n\n\\(\\mathbf{W}^* = \\arg\\min_{\\mathbf{W}} \\left( \\nu \\left( \\tilde{q}^{\\text{pool}}(\\mathbf{W}) \\right)^2 + (1 - \\nu) \\left( \\tilde{q}^{\\text{sep}}(\\mathbf{W}) \\right)^2 + \\lambda \\| \\Gamma \\|_F^2 \\right)\\)"
  },
  {
    "objectID": "slides/09_synth_c.html#optimization-problem-trade-off",
    "href": "slides/09_synth_c.html#optimization-problem-trade-off",
    "title": "(9) Synthetic Controls",
    "section": "Optimization Problem: Trade-off",
    "text": "Optimization Problem: Trade-off"
  },
  {
    "objectID": "slides/09_synth_c.html#optimization-problem-role-of-nu",
    "href": "slides/09_synth_c.html#optimization-problem-role-of-nu",
    "title": "(9) Synthetic Controls",
    "section": "Optimization Problem: Role of \\(\\nu\\)",
    "text": "Optimization Problem: Role of \\(\\nu\\)"
  },
  {
    "objectID": "slides/09_synth_c.html#intercept-shifts",
    "href": "slides/09_synth_c.html#intercept-shifts",
    "title": "(9) Synthetic Controls",
    "section": "Intercept-Shifts",
    "text": "Intercept-Shifts\n\nUnit-specific imbalances can be further improved by adjusting for level differences.\nAdjust for level differences by adding an intercept to the optimization problem:\n\n\\(\\hat{Y}_{j, T_j + k}^*(\\infty) = \\hat{\\alpha}_j + \\sum_i \\hat{w}_{ij}^* Y_{i, T_j + k}\\)\n\n\\(\\hat{\\alpha}_j\\) is the average pre-treatment difference between treated unit & synthetic control:\n\n\\[\n\\begin{aligned}\n\\hat{\\alpha}_j &= \\frac{1}{L_j} \\sum_{\\ell=1}^{L_j} Y_{j, T_j - \\ell} - \\frac{1}{L_j} \\sum_{i=1}^N \\sum_{\\ell=1}^{L_j} \\hat{w}_{ij}^* Y_{j, T_j - \\ell} \\\\\n&= \\bar{Y}_{j, T_j}^{\\text{pre}} - \\sum_i \\hat{w}_{ij}^* \\bar{Y}_{i, T_j}^{\\text{pre}}\n\\end{aligned}\n\\]\n\nTreatment effect estimate is weighted difference-in-differences:\n\n\\(\\hat{\\tau}_{jk} = \\left( Y_{j, T_j + k} - \\bar{Y}_{j, T_j}^{\\text{pre}} \\right) - \\sum_{i=1}^N \\hat{w}_{ij}^* \\left( Y_{i, T_j + k} - \\bar{Y}_{i, T_j}^{\\text{pre}} \\right)\\)."
  },
  {
    "objectID": "slides/09_synth_c.html#optimization-problem-intercept-shifts",
    "href": "slides/09_synth_c.html#optimization-problem-intercept-shifts",
    "title": "(9) Synthetic Controls",
    "section": "Optimization Problem: Intercept-Shifts",
    "text": "Optimization Problem: Intercept-Shifts\n\nIntercept-Shifted Partially-pooled SCM improves the optimization frontier.\n\nWith uniform weights, “stacked” (two-period, two-groups) Difference-in-Differences is obtained."
  },
  {
    "objectID": "slides/09_synth_c.html#sc-with-staggered-timing-example",
    "href": "slides/09_synth_c.html#sc-with-staggered-timing-example",
    "title": "(9) Synthetic Controls",
    "section": "SC with Staggered Timing: Example",
    "text": "SC with Staggered Timing: Example\n\nNext Week!"
  },
  {
    "objectID": "slides/09_synth_c.html#synthetic-difference-in-differences-1",
    "href": "slides/09_synth_c.html#synthetic-difference-in-differences-1",
    "title": "(9) Synthetic Controls",
    "section": "Synthetic Difference-in-Differences",
    "text": "Synthetic Difference-in-Differences\n\nNext Week!"
  }
]